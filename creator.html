<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Kreator danych â€“ DowÃ³d PL</title>
  <link rel="stylesheet" href="assets/app/main.css">
  <link rel="icon" type="image/x-icon" href="assets/app/images/ikonka.png">
  <link rel="apple-touch-icon" href="assets/app/images/ikonka.png">
  <link rel="shortcut icon" href="assets/app/images/ikonka.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="mObywatel">
  <script src="assets/app/manifest.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 0;
      padding-bottom: 100px;
      min-height: 100vh;
    }
    .header {
      background: rgba(26, 29, 36, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }
    .close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }
    .close-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
      font-weight: 600;
    }
    .document-type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }
    .form-container {
      display: none;
      animation: fadeIn 0.4s ease;
    }
    .form-container.visible {
      display: block !important;
      opacity: 1;
    }
    .doc-type-card {
      background: rgba(26, 29, 36, 0.6);
      border: 3px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 24px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
      opacity: 0.6;
    }
    .doc-type-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .doc-type-card:hover {
      border-color: rgba(37, 99, 235, 0.4);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
      opacity: 0.8;
    }
    .doc-type-card.selected {
      border-color: #2563eb;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.3), 0 8px 32px rgba(37, 99, 235, 0.3);
      opacity: 1;
      transform: scale(1.02);
    }
    .doc-type-card.selected::before {
      transform: scaleX(1);
    }
    .doc-type-card.selected .doc-type-icon {
      transform: scale(1.1);
    }
    .doc-type-card.selected .doc-type-title {
      color: #60a5fa;
      font-weight: 700;
    }
    .doc-type-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .doc-type-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .doc-type-desc {
      font-size: 12px;
      color: #aaa;
    }
    .upload-box {
      width: 100%;
      height: 180px;
      border: 2px dashed #2563eb;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
      background: rgba(37, 99, 235, 0.08);
      transition: all 0.3s ease;
    }
    .upload-box:hover {
      background: rgba(37, 99, 235, 0.15);
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
    }
    .upload-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
    }
    .upload-box.has-image::after {
      content: 'Kliknij, aby zmieniÄ‡ zdjÄ™cie';
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
    }
    .upload-icon {
      width: 50px;
      height: 50px;
      margin-bottom: 10px;
      opacity: 0.7;
    }
    .upload-text {
      font-size: 14px;
      color: #2563eb;
    }
    input[type="file"] {
      display: none;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #aaa;
      font-weight: 500;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(26, 29, 36, 0.8);
      color: white;
      font-size: 16px;
      transition: all 0.2s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      background: rgba(26, 29, 36, 1);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    input[type="text"]::placeholder,
    input[type="number"]::placeholder {
      color: #666;
    }
    .date-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 25px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    .submit-btn:active {
      transform: translateY(0);
    }
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }
    .button-group .submit-btn {
      margin-top: 0;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: none;
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    .input-group.error input,
    .input-group.error select {
      border-color: #ef4444;
    }
    .input-group.error .error {
      display: block;
    }
    #installPrompt {
      animation: fadeIn 0.3s ease-in;
    }
    #installPrompt > div {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }
    #installPrompt ol li {
      margin-bottom: 8px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .section-title {
      font-size: 18px;
      margin-bottom: 20px;
      color: white !important;
      font-weight: 600;
      margin-top: 30px;
      display: block !important;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .form-section {
      background: rgba(26, 29, 36, 0.5);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .input-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #ccc;
      font-weight: 500;
    }
  </style>
</head>
<body>
    <button class="refresh_button" onclick="window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now()" title="Force Refresh">â†»</button>
  
  <div class="header">
    <h1>ðŸªª Kreator danych</h1>
    <button class="close-btn" onclick="window.location.href='documents.html'" title="Zamknij">Ã—</button>
  </div>

  <div class="container">
    <div class="document-type-selector">
      <div class="doc-type-card" data-type="mdowod" id="card-mdowod" onclick="selectDocumentType('mdowod'); return false;">
        <div class="doc-type-icon">ðŸªª</div>
        <div class="doc-type-title">mDowÃ³d</div>
        <div class="doc-type-desc">DowÃ³d osobisty</div>
      </div>
      <div class="doc-type-card" data-type="mprawojazdy" id="card-mprawojazdy" onclick="selectDocumentType('mprawojazdy'); return false;">
        <div class="doc-type-icon">ðŸš—</div>
        <div class="doc-type-title">mPrawo jazdy</div>
        <div class="doc-type-desc">Prawo jazdy</div>
      </div>
    </div>
    <div style="text-align: center; margin-top: -15px; margin-bottom: 20px; font-size: 14px; color: #888; min-height: 20px;" id="selectedDocInfo"></div>
    <input type="hidden" id="documentType" required>
    <div class="error" id="documentTypeError" style="display: none; color: #ef4444; font-size: 14px; margin-top: -20px; margin-bottom: 20px; text-align: center;">Wybierz typ dokumentu</div>
    
    <div class="form-container" id="formContainer">
    <div class="upload-box" id="uploadBox">
      <img id="preview" style="display: none;">
      <div id="uploadContent">
        <div class="upload-icon">ðŸ“·</div>
        <p class="upload-text">Dodaj zdjÄ™cie</p>
      </div>
    </div>
    <input type="file" id="imageInput" accept="image/*">

    <form id="creatorForm">
      <div class="form-section">
        <div class="input-group">
          <label>ImiÄ™ (imiona) *</label>
          <input type="text" id="name" required>
          <div class="error">To pole jest wymagane</div>
        </div>

      <div class="input-group">
        <label>Nazwisko *</label>
        <input type="text" id="surname" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Obywatelstwo *</label>
        <input type="text" id="nationality" value="POLSKIE" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Nazwisko rodowe *</label>
        <input type="text" id="familyName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>ImiÄ™ ojca *</label>
        <input type="text" id="fathersName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Nazwisko rodowe ojca *</label>
        <input type="text" id="fathersFamilyName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>ImiÄ™ matki *</label>
        <input type="text" id="mothersName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Nazwisko rodowe matki *</label>
        <input type="text" id="mothersFamilyName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Miejsce urodzenia *</label>
        <input type="text" id="birthPlace" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>PÅ‚eÄ‡ *</label>
        <select id="sex" required>
          <option value="">Wybierz pÅ‚eÄ‡</option>
          <option value="m">MÄ™Å¼czyzna</option>
          <option value="k">Kobieta</option>
        </select>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Data urodzenia *</label>
        <div class="date-row">
          <input type="number" id="day" placeholder="DD" min="1" max="31" required>
          <input type="number" id="month" placeholder="MM" min="1" max="12" required>
          <input type="number" id="year" placeholder="YYYY" min="1900" max="2100" required>
        </div>
        <div class="error">WprowadÅº prawidÅ‚owÄ… datÄ™</div>
      </div>

      </div>
      
      <div class="form-section">
        <p class="section-title">ðŸ“„ Dane dokumentu (opcjonalnie)</p>

      <div class="input-group">
        <label>Numer PESEL</label>
        <input type="text" id="customPesel">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group">
        <label>Kategorie</label>
        <input type="text" id="customKategorie">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group">
        <label>Seria i numer dowodu (np. ZZC 108201)</label>
        <input type="text" id="customSeriesAndNumber">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group">
        <label>Seria i numer dla strony dokumentu (np. ABC 123456)</label>
        <input type="text" id="customDocSeriesNumber">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group">
        <label>Data wydania (np. 11.09.2022)</label>
        <input type="text" id="customGivenDate">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group">
        <label>Termin waÅ¼noÅ›ci (np. 11.09.2032)</label>
        <input type="text" id="customExpiryDate">
        <div class="error">Opcjonalne pole</div>
      </div>
      </div>

      <div class="button-group">
        <button type="button" id="fillRandomBtn" class="submit-btn btn-secondary" style="flex: 1;">WypeÅ‚nij losowo</button>
        <button type="submit" class="submit-btn" style="flex: 2;">Zapisz i pokaÅ¼</button>
      </div>
    </form>
    </div>

    <!-- Instrukcja dodania do ekranu gÅ‚Ã³wnego -->
    <div id="installPrompt" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: #1a1d24; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow-y: auto; color: white;">
        <h2 style="margin-bottom: 20px; text-align: center;">ðŸ“± Dodaj aplikacjÄ™ do ekranu gÅ‚Ã³wnego</h2>
        <div id="iosInstructions" style="display: none;">
          <p style="margin-bottom: 15px; font-weight: 600;">Dla systemu iOS:</p>
          <ol style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
            <li>Upewnij siÄ™, Å¼e uÅ¼ywasz przeglÄ…darki Safari</li>
            <li>Kliknij przycisk <strong>UdostÄ™pnij</strong> (ikonka strzaÅ‚ki w gÃ³rÄ™)</li>
            <li>Wybierz <strong>"Dodaj do ekranu gÅ‚Ã³wnego"</strong></li>
            <li>Kliknij <strong>"Dodaj"</strong></li>
          </ol>
        </div>
        <div id="androidInstructions" style="display: none;">
          <p style="margin-bottom: 15px; font-weight: 600;">Dla systemu Android:</p>
          <ol style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
            <li>Upewnij siÄ™, Å¼e uÅ¼ywasz przeglÄ…darki Chrome lub Google</li>
            <li>Kliknij <strong>Menu</strong> (3 kropki w prawym gÃ³rnym rogu)</li>
            <li>Wybierz <strong>"Dodaj do ekranu gÅ‚Ã³wnego"</strong> lub <strong>"Zainstaluj aplikacjÄ™"</strong></li>
            <li>Kliknij <strong>"Dodaj"</strong> lub <strong>"Zainstaluj"</strong></li>
          </ol>
        </div>
        <button onclick="closeInstallPrompt()" style="width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px;">
          Rozumiem
        </button>
      </div>
    </div>
  </div>

  <script>
    // Document type selection function - define in global scope immediately
    window.selectDocumentType = function(type) {
      console.log('=== selectDocumentType called with:', type, '===');
      
      try {
        // Update card selection
        const cards = document.querySelectorAll('.doc-type-card');
        console.log('Found cards:', cards.length);
        cards.forEach(card => {
          card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`[data-type="${type}"]`);
        console.log('Selected card:', selectedCard);
        if (selectedCard) {
          selectedCard.classList.add('selected');
          console.log('Card selected class added');
        }
        
        // Update hidden input
        const docTypeInput = document.getElementById('documentType');
        console.log('Document type input:', docTypeInput);
        if (docTypeInput) {
          docTypeInput.value = type;
          console.log('Document type set to:', type);
        }
        
        // Hide error
        const errorDiv = document.getElementById('documentTypeError');
        if (errorDiv) {
          errorDiv.style.display = 'none';
        }
        
        // Update info text
        const infoText = document.getElementById('selectedDocInfo');
        const isPrawoJazdy = type === 'mprawojazdy';
        if (infoText) {
          if (isPrawoJazdy) {
            infoText.textContent = 'âœ“ WypeÅ‚niasz dane dla mPrawo jazdy';
            infoText.style.color = '#60a5fa';
          } else {
            infoText.textContent = 'âœ“ WypeÅ‚niasz dane dla mDowÃ³d';
            infoText.style.color = '#60a5fa';
          }
        }
        
        // Show the form container - THIS IS THE KEY PART
        const formContainer = document.getElementById('formContainer');
        console.log('Form container element:', formContainer);
        if (formContainer) {
          console.log('Form container found! Current display:', window.getComputedStyle(formContainer).display);
          formContainer.classList.add('visible');
          formContainer.style.display = 'block';
          formContainer.style.opacity = '1';
          console.log('Form container display set to block');
          console.log('Form container classes:', formContainer.className);
          console.log('Form container computed display:', window.getComputedStyle(formContainer).display);
          
          // Force a reflow
          formContainer.offsetHeight;
          
          // Smooth scroll to form
          setTimeout(() => {
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        } else {
          console.error('ERROR: Form container not found!');
          alert('Form container not found! Check console for details.');
        }
      } catch (error) {
        console.error('Error in selectDocumentType:', error);
        alert('Error: ' + error.message);
      }
    };
    
    console.log('selectDocumentType function defined:', typeof window.selectDocumentType);

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners');
      
      const form = document.getElementById("creatorForm");
      const imageInput = document.getElementById("imageInput");
      const preview = document.getElementById("preview");
      const uploadBox = document.getElementById("uploadBox");
      const uploadContent = document.getElementById("uploadContent");
      let imageBase64 = null;

      // Event listeners are now handled via onclick in HTML
      // But we can also add them here as backup
      const cardMdowod = document.getElementById('card-mdowod');
      const cardMprawojazdy = document.getElementById('card-mprawojazdy');
      
      if (cardMdowod) {
        cardMdowod.addEventListener('click', function(e) {
          console.log('mDowÃ³d card clicked via addEventListener');
          e.preventDefault();
          e.stopPropagation();
          selectDocumentType('mdowod');
        });
      } else {
        console.error('card-mdowod not found!');
      }
      
      if (cardMprawojazdy) {
        cardMprawojazdy.addEventListener('click', function(e) {
          console.log('mPrawo jazdy card clicked via addEventListener');
          e.preventDefault();
          e.stopPropagation();
          selectDocumentType('mprawojazdy');
        });
      } else {
        console.error('card-mprawojazdy not found!');
      }

      // ObsÅ‚uga uploadu zdjÄ™cia
      if (uploadBox) {
        uploadBox.addEventListener("click", () => {
          if (imageInput) imageInput.click();
        });
      }

      if (imageInput) {
        imageInput.addEventListener("change", () => {
          const file = imageInput.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = e => {
            imageBase64 = e.target.result;
            if (preview) {
              preview.src = imageBase64;
              preview.style.display = "block";
            }
            if (uploadContent) uploadContent.style.display = "none";
            if (uploadBox) uploadBox.classList.add("has-image");
          };
          reader.readAsDataURL(file);
        });
      }
    }); // End of DOMContentLoaded

    // Make function globally accessible
    window.selectDocumentType = selectDocumentType;

    // Variables for form handling (will be set in DOMContentLoaded)
    let form, imageInput, preview, uploadBox, uploadContent, imageBase64 = null;

    // Wait for DOM to be ready for form handling
    document.addEventListener('DOMContentLoaded', function() {
      form = document.getElementById("creatorForm");
      imageInput = document.getElementById("imageInput");
      preview = document.getElementById("preview");
      uploadBox = document.getElementById("uploadBox");
      uploadContent = document.getElementById("uploadContent");

      // Funkcje do IndexedDB
    function getDb(){
      return new Promise((resolve, reject) => {
        const r = indexedDB.open('fobywatel', 1);
        r.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('data')){
            db.createObjectStore('data', { keyPath: 'data' });
          }
        };
        r.onsuccess = e => resolve(e.target.result);
        r.onerror = e => reject(e.target.error);
      });
    }

    function saveData(db, data){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('data','readwrite');
        const store = tx.objectStore('data');
        const req = store.put(data);
        req.onsuccess = () => resolve();
        req.onerror = e => reject(e.target.error);
      });
    }

    function validateForm() {
      let isValid = true;
      const inputs = form.querySelectorAll('input[required], select[required]');
      
      inputs.forEach(input => {
        const group = input.closest('.input-group');
        if (input.type === 'number') {
          const day = parseInt(form.day.value);
          const month = parseInt(form.month.value);
          const year = parseInt(form.year.value);
          
          if (!day || !month || !year || day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
            group.classList.add('error');
            isValid = false;
          } else {
            group.classList.remove('error');
          }
        } else {
          if (!input.value.trim()) {
            group.classList.add('error');
            isValid = false;
          } else {
            group.classList.remove('error');
          }
        }
      });
      
      return isValid;
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();

      // Check document type
      const documentType = form.documentType.value;
      if (!documentType) {
        document.getElementById('documentTypeError').style.display = 'block';
        document.querySelector('.document-type-selector').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      document.getElementById('documentTypeError').style.display = 'none';

      if (!validateForm()) {
        form.querySelector('.error').closest('.input-group').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      const data = {
        data: 'data', // klucz dla IndexedDB
        name: form.name.value.trim(),
        surname: form.surname.value.trim(),
        nationality: form.nationality.value.trim(),
        familyName: form.familyName.value.trim(),
        fathersName: form.fathersName.value.trim(),
        fathersFamilyName: form.fathersFamilyName.value.trim(),
        mothersName: form.mothersName.value.trim(),
        mothersFamilyName: form.mothersFamilyName.value.trim(),
        birthPlace: form.birthPlace.value.trim(),
        sex: form.sex.value,
        day: parseInt(form.day.value),
        month: parseInt(form.month.value),
        year: parseInt(form.year.value)
      };

      // Get document type
      const documentType = form.documentType.value;
      const isPrawoJazdy = documentType === 'mprawojazdy';
      
      // Zapisz opcjonalne pola do localStorage (with document type prefix)
      const customPesel = form.customPesel.value.trim();
      const customKategorie = form.customKategorie.value.trim();
      const customSeriesAndNumber = form.customSeriesAndNumber.value.trim();
      const customDocSeriesNumber = form.customDocSeriesNumber.value.trim();
      const customGivenDate = form.customGivenDate.value.trim();
      const customExpiryDate = form.customExpiryDate.value.trim();

      // Prefix for localStorage keys based on document type
      const prefix = isPrawoJazdy ? 'prawoJazdy_' : '';
      
      if (customPesel) {
        localStorage.setItem(prefix + 'pesel', customPesel);
      }
      if (customKategorie) {
        localStorage.setItem(prefix + 'kategorie', customKategorie);
      }
      if (customSeriesAndNumber) {
        localStorage.setItem(prefix + 'seriesAndNumber', customSeriesAndNumber);
      }
      if (customDocSeriesNumber) {
        // docSeriesNumber is only for mDowÃ³d document page
        if (!isPrawoJazdy) {
          localStorage.setItem('docSeriesNumber', customDocSeriesNumber);
        }
      }
      if (customGivenDate) {
        localStorage.setItem(prefix + 'givenDate', customGivenDate);
      }
      if (customExpiryDate) {
        localStorage.setItem(prefix + 'expiryDate', customExpiryDate);
      }

      // Zapisz dane w IndexedDB (with document type key if prawo jazdy)
      const db = await getDb();
      if (isPrawoJazdy) {
        await saveData(db, { ...data, data: 'prawoJazdy_data' });
      } else {
        await saveData(db, data);
      }

      // Zapisz zdjÄ™cie w IndexedDB (with document type key)
      if (imageBase64) {
        const imageKey = isPrawoJazdy ? 'prawoJazdy_image' : 'image';
        await saveData(db, { data: imageKey, image: imageBase64 });
        // Also save to localStorage for quick access
        localStorage.setItem(prefix + 'userPhoto', imageBase64);
      }

      localStorage.setItem('hasUserData', 'true');

      // SprawdÅº czy aplikacja jest juÅ¼ zainstalowana
      const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;
      
      // Redirect to appropriate card page based on document type
      const cardPage = isPrawoJazdy ? 'prawo_jazdy_card.html' : 'card.html';
      window.location.href = cardPage;
    });

    function showInstallPrompt() {
      const prompt = document.getElementById('installPrompt');
      const ios = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const android = /Android/.test(navigator.userAgent);
      
      if (ios) {
        document.getElementById('iosInstructions').style.display = 'block';
        document.getElementById('androidInstructions').style.display = 'none';
      } else if (android) {
        document.getElementById('iosInstructions').style.display = 'none';
        document.getElementById('androidInstructions').style.display = 'block';
      } else {
        document.getElementById('iosInstructions').style.display = 'block';
        document.getElementById('androidInstructions').style.display = 'block';
      }
      
      prompt.style.display = 'flex';
    }

    function closeInstallPrompt() {
      document.getElementById('installPrompt').style.display = 'none';
      // Redirect to appropriate card page
      const documentType = form.documentType.value;
      const isPrawoJazdy = documentType === 'mprawojazdy';
      const cardPage = isPrawoJazdy ? 'prawo_jazdy_card.html' : 'card.html';
      window.location.href = cardPage;
    }

    // ObsÅ‚uga eventu beforeinstallprompt dla Chrome
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // --- Random fill utility (fills all form fields with plausible random data) ---
    function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function pick(arr) { return arr[randomInt(0, arr.length - 1)]; }

    const FIRST_NAMES = ['Jan','Anna','Piotr','Katarzyna','Andrzej','Monika','Tomasz','Magdalena'];
    const LAST_NAMES = ['Nowak','Kowalski','WiÅ›niewski','WÃ³jcik','Kaczmarek','Mazur','Krawczyk','KozÅ‚owski'];

    function randomPeselLike(){
      // produce 11-char alphanumeric-ish string so user can enter non-strict value too
      const chars = '0123456789abcdefghijklmnopqrstuvwxyz';
      let s = '';
      for(let i=0;i<11;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
      return s;
    }

    function pad(n){ return n < 10 ? '0'+n : ''+n; }

    function fillRandom(){
      try{
        document.getElementById('name').value = pick(FIRST_NAMES);
        document.getElementById('surname').value = pick(LAST_NAMES);
        document.getElementById('nationality').value = 'POLSKIE';
        document.getElementById('familyName').value = pick(LAST_NAMES);
        document.getElementById('fathersName').value = pick(FIRST_NAMES);
        document.getElementById('fathersFamilyName').value = pick(LAST_NAMES);
        document.getElementById('mothersName').value = pick(FIRST_NAMES);
        document.getElementById('mothersFamilyName').value = pick(LAST_NAMES);
        document.getElementById('birthPlace').value = 'Warszawa';
        document.getElementById('sex').value = 'm';
        document.getElementById('day').value = pad(randomInt(1,28));
        document.getElementById('month').value = pad(randomInt(1,12));
        document.getElementById('year').value = randomInt(1950, 2004);

        // Optional document fields
        document.getElementById('customPesel').value = randomPeselLike();
        document.getElementById('customSeriesAndNumber').value = 'ZZC ' + String(randomInt(10000,99999));
        document.getElementById('customDocSeriesNumber').value = 'ABC ' + String(randomInt(100000,999999));
        // givenDate and expiryDate - plausible formats dd.mm.yyyy
        const gy = randomInt(2010,2023);
        const gm = pad(randomInt(1,12));
        const gd = pad(randomInt(1,28));
        document.getElementById('customGivenDate').value = gd + '.' + gm + '.' + gy;
        const ey = gy + 5;
        document.getElementById('customExpiryDate').value = gd + '.' + gm + '.' + ey;
      }catch(e){ console.error('fillRandom error', e); }
    }

    document.getElementById('fillRandomBtn').addEventListener('click', fillRandom);
  </script>
</body>
</html>
