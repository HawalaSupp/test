<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Kreator danych ‚Äì Dow√≥d PL</title>
  <link rel="stylesheet" href="assets/app/main.css">
  <link rel="icon" type="image/x-icon" href="assets/app/images/AppIcon~phone~1792@2x~180x180.png">
  <link rel="apple-touch-icon" href="assets/app/images/AppIcon~phone~1792@2x~180x180.png">
  <link rel="shortcut icon" href="assets/app/images/AppIcon~phone~1792@2x~180x180.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="mObywatel">
  <script src="assets/app/manifest.js"></script>
  <script>
    // Define function IMMEDIATELY in head - before any HTML loads
    function selectDocumentType(type) {
      console.log('=== selectDocumentType called with:', type, '===');
      
      try {
        // Update card selection
        const cards = document.querySelectorAll('.doc-type-card');
        console.log('Found cards:', cards.length);
        cards.forEach(card => {
          card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`[data-type="${type}"]`);
        console.log('Selected card:', selectedCard);
        if (selectedCard) {
          selectedCard.classList.add('selected');
          console.log('Card selected class added');
        }
        
        // Update hidden input
        const docTypeInput = document.getElementById('documentType');
        console.log('Document type input:', docTypeInput);
        if (docTypeInput) {
          docTypeInput.value = type;
          console.log('Document type set to:', type);
        }
        
        // Hide error
        const errorDiv = document.getElementById('documentTypeError');
        if (errorDiv) {
          errorDiv.style.display = 'none';
        }
        
        // Update info text
        const infoText = document.getElementById('selectedDocInfo');
        const isPrawoJazdy = type === 'mprawojazdy';
        const docTypeNames = {
          'mdowod': 'mDow√≥d',
          'mprawojazdy': 'mPrawo jazdy',
          'legitymacja': 'Legitymacja aplikanta radcowskiego',
          'legitymacja_adwokacka': 'Legitymacja adwokacka',
          'legitymacja_studencka': 'Legitymacja studencka',
          'karta_duzej_rodziny': 'Karta Du≈ºej Rodziny',
          'diia': 'Diia.pl card',
          'bieglego_rewidenta': 'Legitymacja bieg≈Çego rewidenta',
          'doradcy_podatkowego': 'Legitymacja doradcy podatkowego',
          'inzyniera_budownictwa': 'Legitymacja in≈ºyniera budownictwa',
          'radcy_prawnego': 'Legitymacja radcy prawnego',
          'pwz_lekarza': 'PWZ lekarza',
          'poselka': 'Legitymacja poselska'
        };
        if (infoText) {
          const docName = docTypeNames[type] || type;
          infoText.textContent = '‚úì Wype≈Çniasz dane dla ' + docName;
          infoText.style.color = '#60a5fa';
        }
        
        // === HIDE ALL OPTIONAL/SPECIFIC FIELDS FIRST ===
        const allOptionalGroups = [
          'nationalityGroup', 'familyNameGroup', 'fathersNameGroup', 'fathersFamilyNameGroup',
          'mothersNameGroup', 'mothersFamilyNameGroup', 'peselGroup', 'kategorieGroup',
          'mdowodSeriesGroup', 'mdowodExpiryGroup', 'mdowodDocSeriesGroup',
          'prawoJazdyFields', 'prawoJazdyFields2', 'prawoJazdyFields3', 'prawoJazdyFields4', 'prawoJazdyFields5',
          'numerWpisuGroup', 'birthCountryGroup', 'professionalTitleGroup', 'auditorNumberGroup',
          'registrationNumberGroup', 'issuingAuthorityGroup', 'policyExpiryDateGroup',
          'pwzNumberGroup', 'pwzIssueDateGroup', 'documentNumberGroup',
          'authorizationTypeGroup', 'legitimationNumberGroup', 'cadenceNumberGroup', 'cardNumberGroup',
          'universityNameGroup', 'albumNumberGroup'
        ];
        allOptionalGroups.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
        
        // Also hide birthPlace and sex for specific card types
        const birthPlaceGroup = document.querySelector('#birthPlace')?.closest('.input-group');
        const sexGroup = document.querySelector('#sex')?.closest('.input-group');
        const birthdayDateGroup = document.getElementById('birthdayDateGroup');
        const givenDateGroup = document.querySelector('#customGivenDate')?.closest('.input-group');
        const expiryDateGroup = document.getElementById('mdowodExpiryGroup');
        const nationalityInputGroup = document.querySelector('#nationality')?.closest('.input-group');
        const peselGroup = document.getElementById('peselGroup');
        
        // Reset all labels to defaults
        if (nationalityInputGroup) {
          const label = nationalityInputGroup.querySelector('label');
          if (label) label.textContent = 'Obywatelstwo *';
        }
        if (peselGroup) {
          const label = peselGroup.querySelector('label');
          if (label) label.textContent = 'Numer PESEL';
        }
        if (expiryDateGroup) {
          const label = expiryDateGroup.querySelector('label');
          if (label) label.textContent = 'Termin wa≈ºno≈õci (np. 11.09.2032)';
        }
        if (givenDateGroup) {
          const label = givenDateGroup.querySelector('label');
          if (label) label.textContent = 'Data wydania (np. 11.09.2022)';
        }
        if (birthdayDateGroup) {
          const label = birthdayDateGroup.querySelector('label');
          if (label) label.textContent = 'Data urodzenia *';
        }
        
        // Remove all required attributes from optional fields
        const optionalInputIds = ['familyName', 'fathersName', 'fathersFamilyName', 'mothersName', 'mothersFamilyName',
          'numerWpisu', 'birthCountry', 'professionalTitle', 'auditorNumber', 'registrationNumber',
          'issuingAuthority', 'pwzNumber', 'pwzIssueDate', 'documentNumber',
          'authorizationType', 'legitimationNumber', 'cadenceNumber', 'cardNumber',
          'universityName', 'albumNumber'];
        optionalInputIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.removeAttribute('required');
        });
        
        // === NOW SHOW FIELDS BASED ON DOCUMENT TYPE ===
        
        if (type === 'mdowod') {
          // mDow√≥d - show all standard fields
          if (nationalityInputGroup) nationalityInputGroup.style.display = 'block';
          document.getElementById('familyNameGroup').style.display = 'block';
          document.getElementById('fathersNameGroup').style.display = 'block';
          document.getElementById('fathersFamilyNameGroup').style.display = 'block';
          document.getElementById('mothersNameGroup').style.display = 'block';
          document.getElementById('mothersFamilyNameGroup').style.display = 'block';
          if (birthPlaceGroup) birthPlaceGroup.style.display = 'block';
          if (sexGroup) sexGroup.style.display = 'block';
          if (birthdayDateGroup) birthdayDateGroup.style.display = 'block';
          if (peselGroup) peselGroup.style.display = 'block';
          document.getElementById('mdowodSeriesGroup').style.display = 'block';
          document.getElementById('mdowodDocSeriesGroup').style.display = 'block';
          if (givenDateGroup) givenDateGroup.style.display = 'block';
          if (expiryDateGroup) expiryDateGroup.style.display = 'block';
          // Set required
          ['familyName', 'fathersName', 'fathersFamilyName', 'mothersName', 'mothersFamilyName', 'nationality'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.setAttribute('required', 'required');
          });
          
        } else if (type === 'mprawojazdy') {
          // mPrawo jazdy
          if (birthPlaceGroup) birthPlaceGroup.style.display = 'block';
          if (sexGroup) sexGroup.style.display = 'block';
          if (birthdayDateGroup) birthdayDateGroup.style.display = 'block';
          if (givenDateGroup) givenDateGroup.style.display = 'block';
          if (peselGroup) peselGroup.style.display = 'block';
          document.getElementById('kategorieGroup').style.display = 'block';
          document.getElementById('prawoJazdyFields').style.display = 'block';
          document.getElementById('prawoJazdyFields2').style.display = 'block';
          document.getElementById('prawoJazdyFields3').style.display = 'block';
          document.getElementById('prawoJazdyFields4').style.display = 'block';
          document.getElementById('prawoJazdyFields5').style.display = 'block';
          
        } else if (type === 'legitymacja') {
          // Legitymacja aplikanta radcowskiego: Imiƒô, Nazwisko, Tytu≈Ç, Numer wpisu, Przynale≈ºno≈õƒá
          if (nationalityInputGroup) {
            nationalityInputGroup.style.display = 'block';
            const label = nationalityInputGroup.querySelector('label');
            if (label) label.textContent = 'Tytu≈Ç *';
          }
          document.getElementById('numerWpisuGroup').style.display = 'block';
          if (peselGroup) {
            peselGroup.style.display = 'block';
            const label = peselGroup.querySelector('label');
            if (label) label.textContent = 'Przynale≈ºno≈õƒá';
          }
          if (expiryDateGroup) {
            expiryDateGroup.style.display = 'block';
            const label = expiryDateGroup.querySelector('label');
            if (label) label.textContent = 'Numer legitymacji';
          }
          if (givenDateGroup) {
            givenDateGroup.style.display = 'block';
            const label = givenDateGroup.querySelector('label');
            if (label) label.textContent = 'Data wa≈ºno≈õci legitymacji';
          }
          document.getElementById('numerWpisu').setAttribute('required', 'required');
          document.getElementById('nationality').setAttribute('required', 'required');
          
        } else if (type === 'legitymacja_adwokacka') {
          // Same as legitymacja radcowskiego
          if (nationalityInputGroup) {
            nationalityInputGroup.style.display = 'block';
            const label = nationalityInputGroup.querySelector('label');
            if (label) label.textContent = 'Tytu≈Ç *';
          }
          document.getElementById('numerWpisuGroup').style.display = 'block';
          if (peselGroup) {
            peselGroup.style.display = 'block';
            const label = peselGroup.querySelector('label');
            if (label) label.textContent = 'Przynale≈ºno≈õƒá';
          }
          if (expiryDateGroup) {
            expiryDateGroup.style.display = 'block';
            const label = expiryDateGroup.querySelector('label');
            if (label) label.textContent = 'Numer legitymacji';
          }
          if (givenDateGroup) {
            givenDateGroup.style.display = 'block';
            const label = givenDateGroup.querySelector('label');
            if (label) label.textContent = 'Data wa≈ºno≈õci legitymacji';
          }
          document.getElementById('numerWpisu').setAttribute('required', 'required');
          document.getElementById('nationality').setAttribute('required', 'required');
          
        } else if (type === 'legitymacja_studencka') {
          // Legitymacja studencka: Imiƒô, Nazwisko, Data urodzenia, Numer PESEL, Data wydania, Nazwa uczelni, Numer albumu
          if (birthdayDateGroup) birthdayDateGroup.style.display = 'block';
          if (peselGroup) peselGroup.style.display = 'block';
          if (givenDateGroup) {
            givenDateGroup.style.display = 'block';
            const label = givenDateGroup.querySelector('label');
            if (label) label.textContent = 'Data wydania';
          }
          document.getElementById('universityNameGroup').style.display = 'block';
          document.getElementById('albumNumberGroup').style.display = 'block';
          document.getElementById('universityName').setAttribute('required', 'required');
          document.getElementById('albumNumber').setAttribute('required', 'required');
          
        } else if (type === 'karta_duzej_rodziny') {
          // Karta Du≈ºej Rodziny: Imiƒô, Nazwisko, Numer PESEL, Numer karty, Termin wa≈ºno≈õci
          if (peselGroup) peselGroup.style.display = 'block';
          document.getElementById('cardNumberGroup').style.display = 'block';
          if (expiryDateGroup) {
            expiryDateGroup.style.display = 'block';
            const label = expiryDateGroup.querySelector('label');
            if (label) label.textContent = 'Termin wa≈ºno≈õci';
          }
          document.getElementById('cardNumber').setAttribute('required', 'required');
          
        } else if (type === 'diia') {
          // Diia.pl: Imiƒô, Nazwisko, Data urodzenia, Numer PESEL. Boxes: Kraj pochodzenia, Miejsce urodzenia, Obywatelstwo
          if (birthdayDateGroup) birthdayDateGroup.style.display = 'block';
          if (peselGroup) peselGroup.style.display = 'block';
          document.getElementById('birthCountryGroup').style.display = 'block';
          if (birthPlaceGroup) birthPlaceGroup.style.display = 'block';
          if (nationalityInputGroup) nationalityInputGroup.style.display = 'block';
          document.getElementById('birthCountry').setAttribute('required', 'required');
          document.getElementById('nationality').setAttribute('required', 'required');
          
        } else if (type === 'bieglego_rewidenta') {
          // Legitymacja bieg≈Çego rewidenta: Imiƒô, Nazwisko, Tytu≈Ç zawodowy, Numer bieg≈Çego rewidenta, Przynale≈ºno≈õƒá
          document.getElementById('professionalTitleGroup').style.display = 'block';
          document.getElementById('auditorNumberGroup').style.display = 'block';
          if (peselGroup) {
            peselGroup.style.display = 'block';
            const label = peselGroup.querySelector('label');
            if (label) label.textContent = 'Przynale≈ºno≈õƒá';
          }
          document.getElementById('professionalTitle').setAttribute('required', 'required');
          document.getElementById('auditorNumber').setAttribute('required', 'required');
          
        } else if (type === 'doradcy_podatkowego') {
          // Legitymacja doradcy podatkowego: Imiƒô, Nazwisko, Tytu≈Ç zawodowy, Numer wpisu, Organ wydajƒÖcy. Box: Numer legitymacji
          document.getElementById('professionalTitleGroup').style.display = 'block';
          document.getElementById('numerWpisuGroup').style.display = 'block';
          document.getElementById('issuingAuthorityGroup').style.display = 'block';
          if (expiryDateGroup) {
            expiryDateGroup.style.display = 'block';
            const label = expiryDateGroup.querySelector('label');
            if (label) label.textContent = 'Numer legitymacji';
          }
          document.getElementById('professionalTitle').setAttribute('required', 'required');
          document.getElementById('numerWpisu').setAttribute('required', 'required');
          document.getElementById('issuingAuthority').setAttribute('required', 'required');
          
        } else if (type === 'inzyniera_budownictwa') {
          // Legitymacja in≈ºyniera budownictwa: Imiƒô, Nazwisko, Numer PESEL, Numer ewidencyjny, Termin wa≈ºno≈õci. Boxes: Organ wydajƒÖcy, Termin wa≈ºno≈õci polisy OC
          if (peselGroup) peselGroup.style.display = 'block';
          document.getElementById('registrationNumberGroup').style.display = 'block';
          if (expiryDateGroup) expiryDateGroup.style.display = 'block';
          document.getElementById('issuingAuthorityGroup').style.display = 'block';
          document.getElementById('policyExpiryDateGroup').style.display = 'block';
          document.getElementById('registrationNumber').setAttribute('required', 'required');
          document.getElementById('issuingAuthority').setAttribute('required', 'required');
          
        } else if (type === 'radcy_prawnego') {
          // Legitymacja radcy prawnego: Imiƒô, Nazwisko, Tytu≈Ç, Numer wpisu, Przynale≈ºno≈õƒá. Boxes: Numer legitymacji, Data wa≈ºno≈õci legitymacji, Data urodzenia
          if (nationalityInputGroup) {
            nationalityInputGroup.style.display = 'block';
            const label = nationalityInputGroup.querySelector('label');
            if (label) label.textContent = 'Tytu≈Ç *';
          }
          document.getElementById('numerWpisuGroup').style.display = 'block';
          if (peselGroup) {
            peselGroup.style.display = 'block';
            const label = peselGroup.querySelector('label');
            if (label) label.textContent = 'Przynale≈ºno≈õƒá';
          }
          if (expiryDateGroup) {
            expiryDateGroup.style.display = 'block';
            const label = expiryDateGroup.querySelector('label');
            if (label) label.textContent = 'Numer legitymacji';
          }
          if (givenDateGroup) {
            givenDateGroup.style.display = 'block';
            const label = givenDateGroup.querySelector('label');
            if (label) label.textContent = 'Data wa≈ºno≈õci legitymacji';
          }
          if (birthdayDateGroup) {
            birthdayDateGroup.style.display = 'block';
            const label = birthdayDateGroup.querySelector('label');
            if (label) label.textContent = 'Data urodzenia';
          }
          document.getElementById('numerWpisu').setAttribute('required', 'required');
          document.getElementById('nationality').setAttribute('required', 'required');
          
        } else if (type === 'pwz_lekarza') {
          // PWZ lekarza: Imiƒô, Nazwisko, Tytu≈Ç zawodowy, Numer PWZ, Data uzyskania PWZ, Termin wa≈ºno≈õci. Boxes: Numer dokumentu, Organ przyznajƒÖcy PWZ
          document.getElementById('professionalTitleGroup').style.display = 'block';
          document.getElementById('pwzNumberGroup').style.display = 'block';
          document.getElementById('pwzIssueDateGroup').style.display = 'block';
          if (expiryDateGroup) expiryDateGroup.style.display = 'block';
          document.getElementById('documentNumberGroup').style.display = 'block';
          document.getElementById('issuingAuthorityGroup').style.display = 'block';
          const issuingLabel = document.querySelector('#issuingAuthorityGroup label');
          if (issuingLabel) issuingLabel.textContent = 'Organ przyznajƒÖcy PWZ';
          document.getElementById('professionalTitle').setAttribute('required', 'required');
          document.getElementById('pwzNumber').setAttribute('required', 'required');
          document.getElementById('pwzIssueDate').setAttribute('required', 'required');
          document.getElementById('documentNumber').setAttribute('required', 'required');
          document.getElementById('issuingAuthority').setAttribute('required', 'required');
          
        } else if (type === 'poselka') {
          // Legitymacja poselska: Imiƒô, Nazwisko, Rodzaj uprawnienia, Data wydania, Numer legitymacji, Numer kadencji
          document.getElementById('authorizationTypeGroup').style.display = 'block';
          if (givenDateGroup) {
            givenDateGroup.style.display = 'block';
            const label = givenDateGroup.querySelector('label');
            if (label) label.textContent = 'Data wydania';
          }
          document.getElementById('legitimationNumberGroup').style.display = 'block';
          document.getElementById('cadenceNumberGroup').style.display = 'block';
          document.getElementById('authorizationType').setAttribute('required', 'required');
          document.getElementById('legitimationNumber').setAttribute('required', 'required');
          document.getElementById('cadenceNumber').setAttribute('required', 'required');
        }
        
        // Show the form container - THIS IS THE KEY PART
        const formContainer = document.getElementById('formContainer');
        console.log('Form container element:', formContainer);
        if (formContainer) {
          console.log('Form container found!');
          console.log('Before - display:', window.getComputedStyle(formContainer).display);
          console.log('Before - classes:', formContainer.className);
          
          // Remove any inline display:none
          formContainer.removeAttribute('style');
          
          // Add visible class
          formContainer.classList.add('visible');
          
          // Force display with inline style (highest priority)
          formContainer.style.setProperty('display', 'block', 'important');
          formContainer.style.setProperty('opacity', '1', 'important');
          formContainer.style.setProperty('visibility', 'visible', 'important');
          
          console.log('After - display:', window.getComputedStyle(formContainer).display);
          console.log('After - classes:', formContainer.className);
          console.log('After - inline style:', formContainer.style.cssText);
          
          // Force a reflow to ensure browser applies changes
          void formContainer.offsetHeight;
          
          // Verify it's actually visible
          const finalDisplay = window.getComputedStyle(formContainer).display;
          console.log('Final computed display:', finalDisplay);
          
          if (finalDisplay === 'none') {
            console.error('WARNING: Form container still has display:none after all attempts!');
          } else {
            console.log('SUCCESS: Form container should now be visible!');
          }
          
          // Smooth scroll to form
          setTimeout(() => {
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        } else {
          console.error('ERROR: Form container not found!');
        }
      } catch (error) {
        console.error('Error in selectDocumentType:', error);
      }
    }
    
    // Make it globally accessible
    window.selectDocumentType = selectDocumentType;
    console.log('selectDocumentType function defined in head:', typeof window.selectDocumentType);

    // --- Define fillRandom helper functions IMMEDIATELY in head ---
    window.randomInt = function(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; };
    window.pick = function(arr) { return arr[window.randomInt(0, arr.length - 1)]; };
    window.FIRST_NAMES = ['Jan','Anna','Piotr','Katarzyna','Andrzej','Monika','Tomasz','Magdalena'];
    window.LAST_NAMES = ['Nowak','Kowalski','Wi≈õniewski','W√≥jcik','Kaczmarek','Mazur','Krawczyk','Koz≈Çowski'];
    window.randomPeselLike = function(){
      const chars = '0123456789abcdefghijklmnopqrstuvwxyz';
      let s = '';
      for(let i=0;i<11;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
      return s;
    };
    window.pad = function(n){ return n < 10 ? '0'+n : ''+n; };
    window.setValueAndTrigger = function(el, value) {
      if (!el) {
        console.warn('setValueAndTrigger: element not found');
        return;
      }
      el.value = value;
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
      const group = el.closest('.input-group');
      if (group) group.classList.remove('error');
      console.log('Set value for element:', el.id || el.name, '=', value);
    };

    // Define fillRandom function in head - available immediately
    window.fillRandom = function fillRandom(){
      try{
        console.log('fillRandom called');
        if (!window.pick || !window.randomInt) {
          alert('B≈ÇƒÖd: Funkcje pomocnicze nie sƒÖ dostƒôpne');
          console.error('Helper functions not available');
          return;
        }
        
        // Make sure form container is visible
        const formContainer = document.getElementById('formContainer');
        if (formContainer) {
          const containerDisplay = window.getComputedStyle(formContainer).display;
          if (containerDisplay === 'none') {
            formContainer.style.display = 'block';
            formContainer.style.opacity = '1';
            formContainer.style.visibility = 'visible';
            console.log('Form container was hidden, made it visible');
          }
        }
        
        // Check which document type is selected
        const docTypeInput = document.getElementById('documentType');
        const isPrawoJazdy = docTypeInput && docTypeInput.value === 'mprawojazdy';
        console.log('Document type:', docTypeInput ? docTypeInput.value : 'none', 'isPrawoJazdy:', isPrawoJazdy);
        const fillAllTypes = !docTypeInput || !docTypeInput.value;
        
        // Common fields (always filled)
        window.setValueAndTrigger(document.getElementById('name'), window.pick(window.FIRST_NAMES));
        window.setValueAndTrigger(document.getElementById('surname'), window.pick(window.LAST_NAMES));
        
        // Only fill these fields for mDow√≥d
        if (!isPrawoJazdy || fillAllTypes) {
          window.setValueAndTrigger(document.getElementById('familyName'), window.pick(window.LAST_NAMES));
          window.setValueAndTrigger(document.getElementById('fathersFamilyName'), window.pick(window.LAST_NAMES));
          window.setValueAndTrigger(document.getElementById('mothersFamilyName'), window.pick(window.LAST_NAMES));
        }
        window.setValueAndTrigger(document.getElementById('birthPlace'), 'Warszawa');
        window.setValueAndTrigger(document.getElementById('sex'), window.pick(['m', 'k']));
        window.setValueAndTrigger(document.getElementById('day'), window.pad(window.randomInt(1,28)));
        window.setValueAndTrigger(document.getElementById('month'), window.pad(window.randomInt(1,12)));
        window.setValueAndTrigger(document.getElementById('year'), window.randomInt(1950, 2004));
        
        // Only fill PESEL for mDow√≥d
        if (!isPrawoJazdy || fillAllTypes) {
          window.setValueAndTrigger(document.getElementById('customPesel'), window.randomPeselLike());
        }
        
        // givenDate
        const gy = window.randomInt(2010,2023);
        const gm = window.pad(window.randomInt(1,12));
        const gd = window.pad(window.randomInt(1,28));
        window.setValueAndTrigger(document.getElementById('customGivenDate'), gd + '.' + gm + '.' + gy);

        if (isPrawoJazdy || fillAllTypes) {
          // Select random categories using checkboxes
          const categoryInputs = document.querySelectorAll('.category-input');
          const allCategories = ['A', 'A1', 'B', 'B1', 'C', 'C1', 'D', 'D1'];
          // Select 1-3 random categories
          const numCategories = window.randomInt(1, 3);
          const selectedCategories = [];
          for (let i = 0; i < numCategories; i++) {
            const randomCat = window.pick(allCategories.filter(c => !selectedCategories.includes(c)));
            if (randomCat) selectedCategories.push(randomCat);
          }
          // Check the selected category checkboxes
          categoryInputs.forEach(input => {
            input.checked = selectedCategories.includes(input.value);
          });
          // Update the hidden input
          document.getElementById('customKategorie').value = selectedCategories.join(', ');
          window.setValueAndTrigger(document.getElementById('customWydany'), window.pick(['Wydany', 'Zastrze≈ºony', 'Uniewa≈ºniony']));
          window.setValueAndTrigger(document.getElementById('customNumerDokumentu'), String(window.randomInt(100000, 999999)));
          window.setValueAndTrigger(document.getElementById('customNumerBlankietu'), String(window.randomInt(1000000, 9999999)));
          window.setValueAndTrigger(document.getElementById('customOrganWydajacy'), window.pick(['UrzƒÖd Wojew√≥dzki w Warszawie', 'UrzƒÖd Wojew√≥dzki w Krakowie', 'UrzƒÖd Wojew√≥dzki w Poznaniu', 'Starostwo Powiatowe']));
          window.setValueAndTrigger(document.getElementById('customOgraniczenia'), window.pick(['Brak', 'Okulary', 'Soczewki', 'Okulary lub soczewki', 'Proteza ko≈Ñczyny']));
        }
        
        if (!isPrawoJazdy || fillAllTypes) {
          window.setValueAndTrigger(document.getElementById('nationality'), 'POLSKIE');
          window.setValueAndTrigger(document.getElementById('fathersName'), window.pick(window.FIRST_NAMES));
          window.setValueAndTrigger(document.getElementById('mothersName'), window.pick(window.FIRST_NAMES));
          window.setValueAndTrigger(document.getElementById('customSeriesAndNumber'), 'ZZC ' + String(window.randomInt(10000,99999)));
          window.setValueAndTrigger(document.getElementById('customDocSeriesNumber'), 'ABC ' + String(window.randomInt(100000,999999)));
          const ey = gy + 10;
          window.setValueAndTrigger(document.getElementById('customExpiryDate'), gd + '.' + gm + '.' + ey);
        }
        console.log('fillRandom completed successfully');
        const nameEl = document.getElementById('name');
        if (nameEl && nameEl.value) {
          console.log('Successfully filled form. First name value:', nameEl.value);
        } else {
          console.warn('Warning: Form may not have been filled correctly');
        }
      }catch(e){ 
        console.error('fillRandom error', e);
        alert('B≈ÇƒÖd podczas wype≈Çniania formularza: ' + e.message);
      }
    };
    console.log('fillRandom function defined in head:', typeof window.fillRandom);
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 0;
      padding-bottom: 100px;
      min-height: 100vh;
      pointer-events: auto !important;
    }
    /* Override main.css user-select: none for all form inputs - MUST be very specific */
    #creatorForm input,
    #creatorForm select,
    #creatorForm textarea,
    #creatorForm label,
    .form-container input,
    .form-container select,
    .form-container textarea,
    .form-container label,
    .input-group input,
    .input-group select,
    .input-group textarea,
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      -webkit-tap-highlight-color: rgba(37, 99, 235, 0.3) !important;
      pointer-events: auto !important;
    }
    .header {
      background: rgba(26, 29, 36, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }
    .close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }
    .close-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
      font-weight: 600;
    }
    .document-type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 30px;
    }
    .doc-type-card .doc-type-title {
      font-size: 13px;
      line-height: 1.2;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .doc-type-card .doc-type-icon {
      font-size: 28px;
      margin-bottom: 6px;
    }
    .doc-type-card {
      padding: 16px 12px;
    }
    .form-container {
      display: none;
      animation: fadeIn 0.4s ease;
      position: relative;
      z-index: 1;
      pointer-events: auto !important;
    }
    .form-container.visible {
      display: block !important;
      opacity: 1;
      pointer-events: auto !important;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      pointer-events: auto !important;
      position: relative;
      z-index: 100 !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      cursor: text !important;
      touch-action: manipulation !important;
      -webkit-tap-highlight-color: rgba(37, 99, 235, 0.3) !important;
    }
    input:focus,
    select:focus,
    textarea:focus {
      pointer-events: auto !important;
      z-index: 101 !important;
      outline: none !important;
    }
    .input-group {
      pointer-events: auto !important;
      position: relative;
      z-index: 1;
    }
    form {
      pointer-events: auto !important;
      position: relative;
      z-index: 1;
    }
    .doc-type-card {
      background: rgba(26, 29, 36, 0.6);
      border: 3px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 24px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
      opacity: 0.6;
    }
    .doc-type-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .doc-type-card:hover {
      border-color: rgba(37, 99, 235, 0.4);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
      opacity: 0.8;
    }
    .doc-type-card.selected {
      border-color: #2563eb;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.3), 0 8px 32px rgba(37, 99, 235, 0.3);
      opacity: 1;
      transform: scale(1.02);
    }
    .doc-type-card.selected::before {
      transform: scaleX(1);
    }
    .doc-type-card.selected .doc-type-icon {
      transform: scale(1.1);
    }
    .doc-type-card.selected .doc-type-title {
      color: #60a5fa;
      font-weight: 700;
    }
    .doc-type-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .doc-type-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .doc-type-desc {
      font-size: 12px;
      color: #aaa;
    }
    .upload-box {
      width: 100%;
      height: 180px;
      border: 2px dashed #2563eb;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
      background: rgba(37, 99, 235, 0.08);
      transition: all 0.3s ease;
    }
    .upload-box:hover {
      background: rgba(37, 99, 235, 0.15);
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
    }
    .upload-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
    }
    .upload-box.has-image::after {
      content: 'Kliknij, aby zmieniƒá zdjƒôcie';
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
    }
    .upload-icon {
      width: 50px;
      height: 50px;
      margin-bottom: 10px;
      opacity: 0.7;
    }
    .upload-text {
      font-size: 14px;
      color: #2563eb;
    }
    input[type="file"] {
      display: none;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #aaa;
      font-weight: 500;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(26, 29, 36, 0.8);
      color: white;
      font-size: 16px;
      transition: all 0.2s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      background: rgba(26, 29, 36, 1);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    input[type="text"]::placeholder,
    input[type="number"]::placeholder {
      color: #666;
    }
    .categories-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .category-checkbox {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(26, 29, 36, 0.8);
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 0;
    }
    .category-checkbox:hover {
      border-color: #2563eb;
      background: rgba(26, 29, 36, 1);
    }
    .category-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
      accent-color: #2563eb;
    }
    .category-checkbox input[type="checkbox"]:checked + span {
      color: #2563eb;
      font-weight: 600;
    }
    .category-checkbox:has(input[type="checkbox"]:checked) {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.1);
    }
    .category-checkbox span {
      color: white;
      font-size: 16px;
      user-select: none;
    }
    .date-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 25px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    .submit-btn:active {
      transform: translateY(0);
    }
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }
    .button-group .submit-btn {
      margin-top: 0;
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: none;
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    .input-group.error input,
    .input-group.error select {
      border-color: #ef4444;
    }
    .input-group.error .error {
      display: block;
    }
    #installPrompt {
      animation: fadeIn 0.3s ease-in;
    }
    #installPrompt > div {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }
    #installPrompt ol li {
      margin-bottom: 8px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .section-title {
      font-size: 18px;
      margin-bottom: 20px;
      color: white !important;
      font-weight: 600;
      margin-top: 30px;
      display: block !important;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .form-section {
      background: rgba(26, 29, 36, 0.5);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .input-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #ccc;
      font-weight: 500;
    }
  </style>
</head>
<body>
    <button class="refresh_button" onclick="window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now()" title="Force Refresh">‚Üª</button>
  
  <div class="header">
    <h1>ü™™ Kreator danych</h1>
    <button class="close-btn" onclick="window.location.href='documents.html'" title="Zamknij">√ó</button>
  </div>

  <div class="container">
    <div class="document-type-selector">
      <div class="doc-type-card" data-type="mdowod" id="card-mdowod" onclick="selectDocumentType('mdowod'); return false;">
        <div class="doc-type-icon">ü™™</div>
        <div class="doc-type-title">mDow√≥d</div>
        <div class="doc-type-desc">Dow√≥d osobisty</div>
      </div>
      <div class="doc-type-card" data-type="mprawojazdy" id="card-mprawojazdy" onclick="selectDocumentType('mprawojazdy'); return false;">
        <div class="doc-type-icon">üöó</div>
        <div class="doc-type-title">mPrawo jazdy</div>
        <div class="doc-type-desc">Prawo jazdy</div>
      </div>
      <div class="doc-type-card" data-type="legitymacja" id="card-legitymacja" onclick="selectDocumentType('legitymacja'); return false;">
        <div class="doc-type-icon">‚öñÔ∏è</div>
        <div class="doc-type-title">Legitymacja aplikanta radcowskiego</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="legitymacja_adwokacka" id="card-legitymacja_adwokacka" onclick="selectDocumentType('legitymacja_adwokacka'); return false;">
        <div class="doc-type-icon">‚öñÔ∏è</div>
        <div class="doc-type-title">Legitymacja adwokacka</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="legitymacja_studencka" id="card-legitymacja_studencka" onclick="selectDocumentType('legitymacja_studencka'); return false;">
        <div class="doc-type-icon">‚öñÔ∏è</div>
        <div class="doc-type-title">Legitymacja studencka</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="karta_duzej_rodziny" id="card-karta_duzej_rodziny" onclick="selectDocumentType('karta_duzej_rodziny'); return false;">
        <div class="doc-type-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
        <div class="doc-type-title">Karta Du≈ºej Rodziny</div>
        <div class="doc-type-desc">Karta</div>
      </div>
      <div class="doc-type-card" data-type="diia" id="card-diia" onclick="selectDocumentType('diia'); return false;">
        <div class="doc-type-icon">üá∫üá¶</div>
        <div class="doc-type-title">Diia.pl card</div>
        <div class="doc-type-desc">Karta Diia</div>
      </div>
      <div class="doc-type-card" data-type="bieglego_rewidenta" id="card-bieglego_rewidenta" onclick="selectDocumentType('bieglego_rewidenta'); return false;">
        <div class="doc-type-icon">üìä</div>
        <div class="doc-type-title">Legitymacja bieg≈Çego rewidenta</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="doradcy_podatkowego" id="card-doradcy_podatkowego" onclick="selectDocumentType('doradcy_podatkowego'); return false;">
        <div class="doc-type-icon">üíº</div>
        <div class="doc-type-title">Legitymacja doradcy podatkowego</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="inzyniera_budownictwa" id="card-inzyniera_budownictwa" onclick="selectDocumentType('inzyniera_budownictwa'); return false;">
        <div class="doc-type-icon">üèóÔ∏è</div>
        <div class="doc-type-title">Legitymacja in≈ºyniera budownictwa</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="radcy_prawnego" id="card-radcy_prawnego" onclick="selectDocumentType('radcy_prawnego'); return false;">
        <div class="doc-type-icon">‚öñÔ∏è</div>
        <div class="doc-type-title">Legitymacja radcy prawnego</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="pwz_lekarza" id="card-pwz_lekarza" onclick="selectDocumentType('pwz_lekarza'); return false;">
        <div class="doc-type-icon">ü©∫</div>
        <div class="doc-type-title">PWZ lekarza</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
      <div class="doc-type-card" data-type="poselka" id="card-poselka" onclick="selectDocumentType('poselka'); return false;">
        <div class="doc-type-icon">üèõÔ∏è</div>
        <div class="doc-type-title">Legitymacja poselska</div>
        <div class="doc-type-desc">Legitymacja</div>
      </div>
    </div>
    <div style="text-align: center; margin-top: -15px; margin-bottom: 20px; font-size: 14px; color: #888; min-height: 20px;" id="selectedDocInfo"></div>
    <input type="hidden" id="documentType" required>
    <div class="error" id="documentTypeError" style="display: none; color: #ef4444; font-size: 14px; margin-top: -20px; margin-bottom: 20px; text-align: center;">Wybierz typ dokumentu</div>
    
    <div class="form-container" id="formContainer">
    <div class="upload-box" id="uploadBox">
      <img id="preview" style="display: none;">
      <div id="uploadContent">
        <div class="upload-icon">üì∑</div>
        <p class="upload-text">Dodaj zdjƒôcie</p>
      </div>
    </div>
    <input type="file" id="imageInput" accept="image/*">

    <form id="creatorForm">
      <div class="form-section">
        <div class="input-group">
          <label>Imiƒô (imiona) *</label>
          <input type="text" id="name" required>
          <div class="error">To pole jest wymagane</div>
        </div>

      <div class="input-group">
        <label>Nazwisko *</label>
        <input type="text" id="surname" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Obywatelstwo *</label>
        <input type="text" id="nationality" value="POLSKIE" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="familyNameGroup">
        <label>Nazwisko rodowe *</label>
        <input type="text" id="familyName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="fathersNameGroup">
        <label>Imiƒô ojca *</label>
        <input type="text" id="fathersName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="fathersFamilyNameGroup">
        <label>Nazwisko rodowe ojca *</label>
        <input type="text" id="fathersFamilyName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="mothersNameGroup">
        <label>Imiƒô matki *</label>
        <input type="text" id="mothersName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="mothersFamilyNameGroup">
        <label>Nazwisko rodowe matki *</label>
        <input type="text" id="mothersFamilyName" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>Miejsce urodzenia *</label>
        <input type="text" id="birthPlace" required>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group">
        <label>P≈Çeƒá *</label>
        <select id="sex" required>
          <option value="">Wybierz p≈Çeƒá</option>
          <option value="m">Mƒô≈ºczyzna</option>
          <option value="k">Kobieta</option>
        </select>
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="birthdayDateGroup">
        <label>Data urodzenia *</label>
        <div class="date-row">
          <input type="number" id="day" placeholder="DD" min="1" max="31" required>
          <input type="number" id="month" placeholder="MM" min="1" max="12" required>
          <input type="number" id="year" placeholder="YYYY" min="1900" max="2100" required>
        </div>
        <div class="error">Wprowad≈∫ prawid≈ÇowƒÖ datƒô</div>
      </div>
      
      <div class="input-group" id="numerWpisuGroup" style="display: none;">
        <label>Numer wpisu *</label>
        <input type="text" id="numerWpisu" placeholder="Wpisz numer wpisu">
        <div class="error">To pole jest wymagane</div>
      </div>

      <!-- Diia.pl specific fields -->
      <div class="input-group" id="birthCountryGroup" style="display: none;">
        <label>Kraj pochodzenia *</label>
        <input type="text" id="birthCountry" placeholder="Wpisz kraj pochodzenia">
        <div class="error">To pole jest wymagane</div>
      </div>

      <!-- Professional cards specific fields -->
      <div class="input-group" id="professionalTitleGroup" style="display: none;">
        <label>Tytu≈Ç zawodowy *</label>
        <input type="text" id="professionalTitle" placeholder="Wpisz tytu≈Ç zawodowy">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="auditorNumberGroup" style="display: none;">
        <label>Numer bieg≈Çego rewidenta *</label>
        <input type="text" id="auditorNumber" placeholder="Wpisz numer bieg≈Çego rewidenta">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="registrationNumberGroup" style="display: none;">
        <label>Numer ewidencyjny *</label>
        <input type="text" id="registrationNumber" placeholder="Wpisz numer ewidencyjny">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="issuingAuthorityGroup" style="display: none;">
        <label>Organ wydajƒÖcy *</label>
        <input type="text" id="issuingAuthority" placeholder="Wpisz organ wydajƒÖcy">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="policyExpiryDateGroup" style="display: none;">
        <label>Termin wa≈ºno≈õci polisy OC</label>
        <input type="text" id="policyExpiryDate" placeholder="np. 11.09.2025">
        <div class="error">Opcjonalne pole</div>
      </div>

      <!-- PWZ lekarza specific fields -->
      <div class="input-group" id="pwzNumberGroup" style="display: none;">
        <label>Numer PWZ *</label>
        <input type="text" id="pwzNumber" placeholder="Wpisz numer PWZ">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="pwzIssueDateGroup" style="display: none;">
        <label>Data uzyskania PWZ *</label>
        <input type="text" id="pwzIssueDate" placeholder="np. 11.09.2020">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="documentNumberGroup" style="display: none;">
        <label>Numer dokumentu *</label>
        <input type="text" id="documentNumber" placeholder="Wpisz numer dokumentu">
        <div class="error">To pole jest wymagane</div>
      </div>

      <!-- Legitymacja poselska specific fields -->
      <div class="input-group" id="authorizationTypeGroup" style="display: none;">
        <label>Rodzaj uprawnienia *</label>
        <input type="text" id="authorizationType" placeholder="Wpisz rodzaj uprawnienia">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="legitimationNumberGroup" style="display: none;">
        <label>Numer legitymacji *</label>
        <input type="text" id="legitimationNumber" placeholder="Wpisz numer legitymacji">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="cadenceNumberGroup" style="display: none;">
        <label>Numer kadencji *</label>
        <input type="text" id="cadenceNumber" placeholder="Wpisz numer kadencji">
        <div class="error">To pole jest wymagane</div>
      </div>

      <!-- Karta Du≈ºej Rodziny specific fields -->
      <div class="input-group" id="cardNumberGroup" style="display: none;">
        <label>Numer karty *</label>
        <input type="text" id="cardNumber" placeholder="Wpisz numer karty">
        <div class="error">To pole jest wymagane</div>
      </div>

      <!-- Legitymacja studencka specific fields -->
      <div class="input-group" id="universityNameGroup" style="display: none;">
        <label>Nazwa uczelni *</label>
        <input type="text" id="universityName" placeholder="Wpisz nazwƒô uczelni">
        <div class="error">To pole jest wymagane</div>
      </div>

      <div class="input-group" id="albumNumberGroup" style="display: none;">
        <label>Numer albumu *</label>
        <input type="text" id="albumNumber" placeholder="Wpisz numer albumu">
        <div class="error">To pole jest wymagane</div>
      </div>

      </div>
      
      <div class="form-section">
        <p class="section-title">üìÑ Dane dokumentu (opcjonalnie)</p>

      <div class="input-group" id="peselGroup">
        <label>Numer PESEL</label>
        <input type="text" id="customPesel">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="kategorieGroup">
        <label>Kategorie</label>
        <div class="categories-container" id="categoriesContainer">
          <label class="category-checkbox">
            <input type="checkbox" value="A" class="category-input">
            <span>A</span>
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="A1" class="category-input">
            <span>A1</span>
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="B" class="category-input">
            <span>B</span>
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="B1" class="category-input">
            <span>B1</span>
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="C" class="category-input">
            <span>C</span>
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="C1" class="category-input">
            <span>C1</span>
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="D" class="category-input">
            <span>D</span>
          </label>
          <label class="category-checkbox">
            <input type="checkbox" value="D1" class="category-input">
            <span>D1</span>
          </label>
        </div>
        <input type="hidden" id="customKategorie">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="mdowodSeriesGroup" style="display: none;">
        <label>Seria i numer dowodu (np. ZZC 108201)</label>
        <input type="text" id="customSeriesAndNumber">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="mdowodDocSeriesGroup" style="display: none;">
        <label>Seria i numer dla strony dokumentu (np. ABC 123456)</label>
        <input type="text" id="customDocSeriesNumber">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group">
        <label>Data wydania (np. 11.09.2022)</label>
        <input type="text" id="customGivenDate">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="mdowodExpiryGroup" style="display: none;">
        <label>Termin wa≈ºno≈õci (np. 11.09.2032)</label>
        <input type="text" id="customExpiryDate">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="prawoJazdyFields" style="display: none;">
        <label>Status blankietu</label>
        <input type="text" id="customWydany" placeholder="Wydany">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="prawoJazdyFields2" style="display: none;">
        <label>Numer Dokumentu</label>
        <input type="text" id="customNumerDokumentu">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="prawoJazdyFields3" style="display: none;">
        <label>Numer blankietu</label>
        <input type="text" id="customNumerBlankietu">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="prawoJazdyFields4" style="display: none;">
        <label>Organ wydajƒÖcy</label>
        <input type="text" id="customOrganWydajacy">
        <div class="error">Opcjonalne pole</div>
      </div>

      <div class="input-group" id="prawoJazdyFields5" style="display: none;">
        <label>Ograniczenia</label>
        <input type="text" id="customOgraniczenia">
        <div class="error">Opcjonalne pole</div>
      </div>
      </div>

      <div class="button-group">
        <button type="button" id="fillRandomBtn" class="submit-btn btn-secondary" style="flex: 1;" onclick="if(window.fillRandom){window.fillRandom();}else{alert('Funkcja fillRandom nie jest dostƒôpna');} return false;">Wype≈Çnij losowo</button>
        <button type="submit" class="submit-btn" style="flex: 2;">Zapisz i poka≈º</button>
      </div>
    </form>
    </div>

    <!-- Instrukcja dodania do ekranu g≈Ç√≥wnego -->
    <div id="installPrompt" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: #1a1d24; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow-y: auto; color: white;">
        <h2 style="margin-bottom: 20px; text-align: center;">üì± Dodaj aplikacjƒô do ekranu g≈Ç√≥wnego</h2>
        <div id="iosInstructions" style="display: none;">
          <p style="margin-bottom: 15px; font-weight: 600;">Dla systemu iOS:</p>
          <ol style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
            <li>Upewnij siƒô, ≈ºe u≈ºywasz przeglƒÖdarki Safari</li>
            <li>Kliknij przycisk <strong>Udostƒôpnij</strong> (ikonka strza≈Çki w g√≥rƒô)</li>
            <li>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong></li>
            <li>Kliknij <strong>"Dodaj"</strong></li>
          </ol>
        </div>
        <div id="androidInstructions" style="display: none;">
          <p style="margin-bottom: 15px; font-weight: 600;">Dla systemu Android:</p>
          <ol style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
            <li>Upewnij siƒô, ≈ºe u≈ºywasz przeglƒÖdarki Chrome lub Google</li>
            <li>Kliknij <strong>Menu</strong> (3 kropki w prawym g√≥rnym rogu)</li>
            <li>Wybierz <strong>"Dodaj do ekranu g≈Ç√≥wnego"</strong> lub <strong>"Zainstaluj aplikacjƒô"</strong></li>
            <li>Kliknij <strong>"Dodaj"</strong> lub <strong>"Zainstaluj"</strong></li>
          </ol>
        </div>
        <button onclick="closeInstallPrompt()" style="width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px;">
          Rozumiem
        </button>
      </div>
    </div>
  </div>

  <script>
    // Function is already defined in head, just verify
    console.log('Body script loaded - selectDocumentType available:', typeof window.selectDocumentType);
    
    // Remove this duplicate - function is in head
    /*
    window.selectDocumentType = function(type) {
      console.log('=== selectDocumentType called with:', type, '===');
      
      try {
        // Update card selection
        const cards = document.querySelectorAll('.doc-type-card');
        console.log('Found cards:', cards.length);
        cards.forEach(card => {
          card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`[data-type="${type}"]`);
        console.log('Selected card:', selectedCard);
        if (selectedCard) {
          selectedCard.classList.add('selected');
          console.log('Card selected class added');
        }
        
        // Update hidden input
        const docTypeInput = document.getElementById('documentType');
        console.log('Document type input:', docTypeInput);
        if (docTypeInput) {
          docTypeInput.value = type;
          console.log('Document type set to:', type);
        }
        
        // Hide error
        const errorDiv = document.getElementById('documentTypeError');
        if (errorDiv) {
          errorDiv.style.display = 'none';
        }
        
        // Update info text
        const infoText = document.getElementById('selectedDocInfo');
        const isPrawoJazdy = type === 'mprawojazdy';
        if (infoText) {
          if (isPrawoJazdy) {
            infoText.textContent = '‚úì Wype≈Çniasz dane dla mPrawo jazdy';
            infoText.style.color = '#60a5fa';
          } else {
            infoText.textContent = '‚úì Wype≈Çniasz dane dla mDow√≥d';
            infoText.style.color = '#60a5fa';
          }
        }
        
        // Show the form container - THIS IS THE KEY PART
        const formContainer = document.getElementById('formContainer');
        console.log('Form container element:', formContainer);
        if (formContainer) {
          console.log('Form container found!');
          console.log('Before - display:', window.getComputedStyle(formContainer).display);
          console.log('Before - classes:', formContainer.className);
          
          // Remove any inline display:none
          formContainer.removeAttribute('style');
          
          // Add visible class
          formContainer.classList.add('visible');
          
          // Force display with inline style (highest priority)
          formContainer.style.setProperty('display', 'block', 'important');
          formContainer.style.setProperty('opacity', '1', 'important');
          formContainer.style.setProperty('visibility', 'visible', 'important');
          
          console.log('After - display:', window.getComputedStyle(formContainer).display);
          console.log('After - classes:', formContainer.className);
          console.log('After - inline style:', formContainer.style.cssText);
          
          // Force a reflow to ensure browser applies changes
          void formContainer.offsetHeight;
          
          // Verify it's actually visible
          const finalDisplay = window.getComputedStyle(formContainer).display;
          console.log('Final computed display:', finalDisplay);
          
          if (finalDisplay === 'none') {
            console.error('WARNING: Form container still has display:none after all attempts!');
          } else {
            console.log('SUCCESS: Form container should now be visible!');
          }
          
          // Smooth scroll to form
          setTimeout(() => {
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        } else {
          console.error('ERROR: Form container not found!');
        }
      } catch (error) {
        console.error('Error in selectDocumentType:', error);
      }
    };
    */

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners');
      
      // === HIDE ALL OPTIONAL FIELDS ON PAGE LOAD (before any document type is selected) ===
      const allOptionalGroups = [
        'nationalityGroup', 'familyNameGroup', 'fathersNameGroup', 'fathersFamilyNameGroup',
        'mothersNameGroup', 'mothersFamilyNameGroup', 'peselGroup', 'kategorieGroup',
        'mdowodSeriesGroup', 'mdowodExpiryGroup', 'mdowodDocSeriesGroup',
        'prawoJazdyFields', 'prawoJazdyFields2', 'prawoJazdyFields3', 'prawoJazdyFields4', 'prawoJazdyFields5',
        'numerWpisuGroup', 'birthCountryGroup', 'professionalTitleGroup', 'auditorNumberGroup',
        'registrationNumberGroup', 'issuingAuthorityGroup', 'policyExpiryDateGroup',
        'pwzNumberGroup', 'pwzIssueDateGroup', 'documentNumberGroup',
        'authorizationTypeGroup', 'legitimationNumberGroup', 'cadenceNumberGroup', 'cardNumberGroup',
        'universityNameGroup', 'albumNumberGroup', 'birthdayDateGroup', 'birthPlaceGroup', 'sexGroup'
      ];
      allOptionalGroups.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      
      // Also hide the nationality, birthPlace, and sex fields that don't have explicit group IDs
      const nationalityInputGroup = document.querySelector('#nationality')?.closest('.input-group');
      if (nationalityInputGroup) nationalityInputGroup.style.display = 'none';
      const birthPlaceGroup = document.querySelector('#birthPlace')?.closest('.input-group');
      if (birthPlaceGroup) birthPlaceGroup.style.display = 'none';
      const sexGroup = document.querySelector('#sex')?.closest('.input-group');
      if (sexGroup) sexGroup.style.display = 'none';
      const birthdayDateGroup = document.getElementById('birthdayDateGroup');
      if (birthdayDateGroup) birthdayDateGroup.style.display = 'none';
      const givenDateGroup = document.querySelector('#customGivenDate')?.closest('.input-group');
      if (givenDateGroup) givenDateGroup.style.display = 'none';
      const expiryDateGroup = document.getElementById('mdowodExpiryGroup');
      if (expiryDateGroup) expiryDateGroup.style.display = 'none';
      
      console.log('All optional fields hidden on page load');
      // === END HIDE OPTIONAL FIELDS ===
      
      // Note: Card visibility settings are NOT applied here - all cards should always be visible in Kreator danych
      // The visibility settings only apply to documents.html (the main documents list)
      console.log('All document type cards are visible in Kreator danych');
      
      const form = document.getElementById("creatorForm");
      const imageInput = document.getElementById("imageInput");
      const preview = document.getElementById("preview");
      const uploadBox = document.getElementById("uploadBox");
      const uploadContent = document.getElementById("uploadContent");
      let imageBase64 = null;

      // Event listeners are now handled via onclick in HTML
      // But we can also add them here as backup
      const cardMdowod = document.getElementById('card-mdowod');
      const cardMprawojazdy = document.getElementById('card-mprawojazdy');
      
      if (cardMdowod) {
        cardMdowod.addEventListener('click', function(e) {
          console.log('mDow√≥d card clicked via addEventListener');
          e.preventDefault();
          e.stopPropagation();
          selectDocumentType('mdowod');
        });
      } else {
        console.error('card-mdowod not found!');
      }
      
      if (cardMprawojazdy) {
        cardMprawojazdy.addEventListener('click', function(e) {
          console.log('mPrawo jazdy card clicked via addEventListener');
          e.preventDefault();
          e.stopPropagation();
          selectDocumentType('mprawojazdy');
        });
      } else {
        console.error('card-mprawojazdy not found!');
      }

      // Obs≈Çuga uploadu zdjƒôcia
      if (uploadBox) {
        uploadBox.addEventListener("click", () => {
          if (imageInput) imageInput.click();
        });
      }

      if (imageInput) {
        imageInput.addEventListener("change", () => {
          const file = imageInput.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = e => {
            imageBase64 = e.target.result;
            if (preview) {
              preview.src = imageBase64;
              preview.style.display = "block";
            }
            if (uploadContent) uploadContent.style.display = "none";
            if (uploadBox) uploadBox.classList.add("has-image");
          };
          reader.readAsDataURL(file);
        });
      }
    }); // End of DOMContentLoaded

    // Function is already global from head section
    // window.selectDocumentType = selectDocumentType;

    // Variables for form handling (will be set in DOMContentLoaded)
    let form, imageInput, preview, uploadBox, uploadContent, imageBase64 = null;

    // Wait for DOM to be ready for form handling
    document.addEventListener('DOMContentLoaded', function() {
      form = document.getElementById("creatorForm");
      imageInput = document.getElementById("imageInput");
      preview = document.getElementById("preview");
      uploadBox = document.getElementById("uploadBox");
      uploadContent = document.getElementById("uploadContent");
      
      // Ensure all inputs are interactive
      setTimeout(function() {
        const allInputs = document.querySelectorAll('input, select, textarea');
        allInputs.forEach(function(input) {
          input.style.pointerEvents = 'auto';
          input.style.userSelect = 'text';
          input.style.webkitUserSelect = 'text';
          input.removeAttribute('disabled');
          input.removeAttribute('readonly');
          // Remove any event listeners that might be blocking
          input.onclick = null;
          input.onmousedown = null;
          input.ontouchstart = null;
        });
        console.log('Enabled', allInputs.length, 'input fields for interaction');
      }, 100);

      // Handle category checkboxes
      function updateCategoriesInput() {
        const checkboxes = document.querySelectorAll('.category-input:checked');
        const selectedCategories = Array.from(checkboxes).map(cb => cb.value).join(', ');
        const hiddenInput = document.getElementById('customKategorie');
        if (hiddenInput) {
          hiddenInput.value = selectedCategories;
        }
      }

      // Add event listeners to category checkboxes
      const categoryInputs = document.querySelectorAll('.category-input');
      categoryInputs.forEach(input => {
        input.addEventListener('change', updateCategoriesInput);
      });

      // Load saved categories when form is shown
      function loadSavedCategories() {
        const savedKategorie = localStorage.getItem('prawoJazdy_kategorie');
        if (savedKategorie) {
          const categories = savedKategorie.split(',').map(c => c.trim());
          // Query again in case checkboxes weren't available when function was defined
          const inputs = document.querySelectorAll('.category-input');
          inputs.forEach(input => {
            input.checked = categories.includes(input.value);
          });
          updateCategoriesInput();
        }
      }

      // Load categories when document type is selected (override selectDocumentType)
      const originalSelectDocumentType = window.selectDocumentType;
      window.selectDocumentType = function(type) {
        if (originalSelectDocumentType) {
          originalSelectDocumentType(type);
        }
        // Load categories after a short delay to ensure DOM is ready
        setTimeout(loadSavedCategories, 100);
      };

      // Funkcje do IndexedDB
    function getDb(){
      return new Promise((resolve, reject) => {
        const r = indexedDB.open('fobywatel', 1);
        r.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('data')){
            db.createObjectStore('data', { keyPath: 'data' });
          }
        };
        r.onsuccess = e => resolve(e.target.result);
        r.onerror = e => reject(e.target.error);
      });
    }

    function saveData(db, data){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('data','readwrite');
        const store = tx.objectStore('data');
        const req = store.put(data);
        req.onsuccess = () => resolve();
        req.onerror = e => reject(e.target.error);
      });
    }

    function getData(db, key){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('data','readonly');
        const store = tx.objectStore('data');
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    function validateForm() {
      let isValid = true;
      const inputs = form.querySelectorAll('input[required], select[required]');
      
      inputs.forEach(input => {
        const group = input.closest('.input-group');
        // Only validate visible fields
        if (group && window.getComputedStyle(group).display === 'none') {
          return; // Skip hidden fields
        }
        
        if (input.type === 'number') {
          const day = parseInt(form.day.value);
          const month = parseInt(form.month.value);
          const year = parseInt(form.year.value);
          
          if (!day || !month || !year || day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
            group.classList.add('error');
            isValid = false;
          } else {
            group.classList.remove('error');
          }
        } else {
          if (!input.value.trim()) {
            group.classList.add('error');
            isValid = false;
          } else {
            group.classList.remove('error');
          }
        }
      });
      
      return isValid;
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();
      console.log('=== FORM SUBMISSION STARTED ===');

      // Check if form exists
      if (!form) {
        console.error('ERROR: form is undefined!');
        alert('B≈ÇƒÖd: Formularz nie zosta≈Ç znaleziony. Od≈õwie≈º stronƒô.');
        return;
      }

      // Check document type
      const documentTypeInput = document.getElementById('documentType');
      if (!documentTypeInput) {
        console.error('ERROR: documentType input not found!');
        alert('B≈ÇƒÖd: Pole typu dokumentu nie zosta≈Ço znalezione.');
        return;
      }
      
      const documentType = documentTypeInput.value;
      console.log('Document type:', documentType);
      if (!documentType) {
        console.error('No document type selected!');
        document.getElementById('documentTypeError').style.display = 'block';
        document.querySelector('.document-type-selector').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      document.getElementById('documentTypeError').style.display = 'none';

      if (!validateForm()) {
        console.error('Form validation failed!');
        form.querySelector('.error').closest('.input-group').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      console.log('Form validation passed');

      // Get document type and build appropriate data object
      let data = { name: form.name.value.trim(), surname: form.surname.value.trim() };
      let prefix = '';
      let cardPage = 'card.html';
      
      // Helper function to get field value safely
      const getFieldValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
      };
      
      switch (documentType) {
        case 'mdowod':
          prefix = 'mdowod_';
          cardPage = 'card.html';
          data.nationality = getFieldValue('nationality');
          data.familyName = getFieldValue('familyName');
          data.fathersName = getFieldValue('fathersName');
          data.fathersFamilyName = getFieldValue('fathersFamilyName');
          data.mothersName = getFieldValue('mothersName');
          data.mothersFamilyName = getFieldValue('mothersFamilyName');
          data.birthPlace = getFieldValue('birthPlace');
          data.sex = getFieldValue('sex');
          data.day = parseInt(getFieldValue('day')) || 0;
          data.month = parseInt(getFieldValue('month')) || 0;
          data.year = parseInt(getFieldValue('year')) || 0;
          data.pesel = getFieldValue('customPesel');
          data.seriesAndNumber = getFieldValue('customSeriesAndNumber');
          data.docSeriesNumber = getFieldValue('customDocSeriesNumber');
          data.givenDate = getFieldValue('customGivenDate');
          data.expiryDate = getFieldValue('customExpiryDate');
          break;
          
        case 'mprawojazdy':
          prefix = 'prawoJazdy_';
          cardPage = 'prawo_jazdy_card.html';
          data.birthPlace = getFieldValue('birthPlace');
          data.sex = getFieldValue('sex');
          data.day = parseInt(getFieldValue('day')) || 0;
          data.month = parseInt(getFieldValue('month')) || 0;
          data.year = parseInt(getFieldValue('year')) || 0;
          data.pesel = getFieldValue('customPesel');
          data.kategorie = getFieldValue('customKategorie');
          data.givenDate = getFieldValue('customGivenDate');
          data.wydany = getFieldValue('customWydany');
          data.numerDokumentu = getFieldValue('customNumerDokumentu');
          data.numerBlankietu = getFieldValue('customNumerBlankietu');
          data.organWydajacy = getFieldValue('customOrganWydajacy');
          data.ograniczenia = getFieldValue('customOgraniczenia');
          break;
          
        case 'legitymacja':
          prefix = 'legitymacja_';
          cardPage = 'legitymacja_card.html';
          data.nationality = getFieldValue('nationality'); // Tytu≈Ç
          data.numerWpisu = getFieldValue('numerWpisu');
          data.pesel = getFieldValue('customPesel'); // Przynale≈ºno≈õƒá
          data.expiryDate = getFieldValue('customExpiryDate'); // Numer legitymacji
          data.givenDate = getFieldValue('customGivenDate'); // Data wa≈ºno≈õci legitymacji
          break;
          
        case 'legitymacja_adwokacka':
          prefix = 'legitymacja_adwokacka_';
          cardPage = 'legitymacja_adwokacka_card.html';
          data.nationality = getFieldValue('nationality'); // Tytu≈Ç
          data.numerWpisu = getFieldValue('numerWpisu');
          data.pesel = getFieldValue('customPesel'); // Przynale≈ºno≈õƒá
          data.expiryDate = getFieldValue('customExpiryDate'); // Numer legitymacji
          data.givenDate = getFieldValue('customGivenDate'); // Data wa≈ºno≈õci legitymacji
          break;
          
        case 'legitymacja_studencka':
          prefix = 'legitymacja_studencka_';
          cardPage = 'legitymacja_studencka_card.html';
          data.day = parseInt(getFieldValue('day')) || 0;
          data.month = parseInt(getFieldValue('month')) || 0;
          data.year = parseInt(getFieldValue('year')) || 0;
          data.pesel = getFieldValue('customPesel');
          data.givenDate = getFieldValue('customGivenDate');
          data.universityName = getFieldValue('universityName');
          data.albumNumber = getFieldValue('albumNumber');
          break;
          
        case 'karta_duzej_rodziny':
          prefix = 'karta_duzej_rodziny_';
          cardPage = 'karta_duzej_rodziny_card.html';
          data.pesel = getFieldValue('customPesel');
          data.cardNumber = getFieldValue('cardNumber');
          data.expiryDate = getFieldValue('customExpiryDate');
          break;
          
        case 'diia':
          prefix = 'diia_';
          cardPage = 'diia_card.html';
          data.day = parseInt(getFieldValue('day')) || 0;
          data.month = parseInt(getFieldValue('month')) || 0;
          data.year = parseInt(getFieldValue('year')) || 0;
          data.pesel = getFieldValue('customPesel');
          data.birthCountry = getFieldValue('birthCountry');
          data.birthPlace = getFieldValue('birthPlace');
          data.nationality = getFieldValue('nationality');
          break;
          
        case 'bieglego_rewidenta':
          prefix = 'bieglego_rewidenta_';
          cardPage = 'legitymacja_bieglego_rewidenta_card.html';
          data.professionalTitle = getFieldValue('professionalTitle');
          data.auditorNumber = getFieldValue('auditorNumber');
          data.pesel = getFieldValue('customPesel'); // Przynale≈ºno≈õƒá
          break;
          
        case 'doradcy_podatkowego':
          prefix = 'doradcy_podatkowego_';
          cardPage = 'legitymacja_doradcy_podatkowego_card.html';
          data.professionalTitle = getFieldValue('professionalTitle');
          data.entryNumber = getFieldValue('numerWpisu');
          data.issuingAuthority = getFieldValue('issuingAuthority');
          data.expiryDate = getFieldValue('customExpiryDate'); // Numer legitymacji
          break;
          
        case 'inzyniera_budownictwa':
          prefix = 'inzyniera_budownictwa_';
          cardPage = 'legitymacja_inzyniera_budownictwa_card.html';
          data.pesel = getFieldValue('customPesel');
          data.registrationNumber = getFieldValue('registrationNumber');
          data.expiryDate = getFieldValue('customExpiryDate');
          data.issuingAuthority = getFieldValue('issuingAuthority');
          data.policyExpiryDate = getFieldValue('policyExpiryDate');
          break;
          
        case 'radcy_prawnego':
          prefix = 'radcy_prawnego_';
          cardPage = 'legitymacja_radcy_prawnego_card.html';
          data.nationality = getFieldValue('nationality'); // Tytu≈Ç
          data.entryNumber = getFieldValue('numerWpisu');
          data.pesel = getFieldValue('customPesel'); // Przynale≈ºno≈õƒá
          data.expiryDate = getFieldValue('customExpiryDate'); // Numer legitymacji
          data.givenDate = getFieldValue('customGivenDate'); // Data wa≈ºno≈õci legitymacji
          data.day = parseInt(getFieldValue('day')) || 0;
          data.month = parseInt(getFieldValue('month')) || 0;
          data.year = parseInt(getFieldValue('year')) || 0;
          break;
          
        case 'pwz_lekarza':
          prefix = 'pwz_lekarza_';
          cardPage = 'pwz_lekarza_card.html';
          data.professionalTitle = getFieldValue('professionalTitle');
          data.pwzNumber = getFieldValue('pwzNumber');
          data.pwzIssueDate = getFieldValue('pwzIssueDate');
          data.expiryDate = getFieldValue('customExpiryDate');
          data.documentNumber = getFieldValue('documentNumber');
          data.issuingAuthority = getFieldValue('issuingAuthority');
          break;
          
        case 'poselka':
          prefix = 'poselka_';
          cardPage = 'legitymacja_poselka_card.html';
          data.authorizationType = getFieldValue('authorizationType');
          data.issueDate = getFieldValue('customGivenDate');
          data.legitimationNumber = getFieldValue('legitimationNumber');
          data.cadenceNumber = getFieldValue('cadenceNumber');
          break;
          
        default:
          console.error('Unknown document type:', documentType);
          alert('Nieznany typ dokumentu');
          return;
      }
      
      console.log('Data object created:', data);
      console.log('Using prefix:', prefix);
      console.log('Will redirect to:', cardPage);
      
      // Save ALL data as JSON to localStorage (PRIMARY METHOD)
      const storageKey = prefix + 'userData';
      localStorage.setItem(storageKey, JSON.stringify(data));
      console.log('‚úì Saved data to localStorage as JSON with key:', storageKey);
      console.log('‚úì Saved data content:', JSON.stringify(data, null, 2));
      
      // Also save individual fields for compatibility
      Object.keys(data).forEach(key => {
        const itemKey = prefix + key;
        const value = data[key] !== null && data[key] !== undefined ? String(data[key]) : '';
        if (value) {
          localStorage.setItem(itemKey, value);
          console.log('  - Saved', itemKey, '=', value);
        }
      });
      console.log('‚úì Saved individual fields to localStorage');
      
      // Add timestamp to track when data was saved
      localStorage.setItem(storageKey + '_timestamp', Date.now().toString());
      
      // Save birthDay to localStorage in format DD.MM.YYYY (only if day/month/year exist)
      if (data.day && data.month && data.year) {
        const day = String(data.day).padStart(2, '0');
        const month = String(data.month).padStart(2, '0');
        const birthDayFormatted = `${day}.${month}.${data.year}`;
        localStorage.setItem(prefix + 'birthday', birthDayFormatted);
      }

      // Also save to IndexedDB as backup (but don't fail if it doesn't work)
      let db;
      try {
        console.log('Attempting to save to IndexedDB as backup...');
        db = await getDb();
        const dataKey = prefix + 'data';
        const dataToSave = { ...data, data: dataKey };
        await saveData(db, dataToSave);
        console.log('‚úì Also saved to IndexedDB successfully');
      } catch (error) {
        console.warn('‚ö† IndexedDB save failed (but localStorage worked):', error);
      }

      // Zapisz zdjƒôcie w IndexedDB (with document type key)
      if (imageBase64) {
        try {
          const imageKey = prefix + 'image';
          console.log('Saving image to IndexedDB with key:', imageKey);
          await saveData(db, { data: imageKey, image: imageBase64 });
          localStorage.setItem(prefix + 'userPhoto', imageBase64);
          console.log('Image saved successfully');
        } catch (error) {
          console.error('Error saving image:', error);
        }
      }

      localStorage.setItem('hasUserData', 'true');
      console.log('=== ALL DATA SAVED SUCCESSFULLY ===');
      console.log('Redirecting to:', cardPage);
      
      // Add a small delay to ensure localStorage is fully written
      setTimeout(() => {
        window.location.href = cardPage;
      }, 200);
    });
    }); // End of DOMContentLoaded (line 959)

    function showInstallPrompt() {
      const prompt = document.getElementById('installPrompt');
      const ios = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const android = /Android/.test(navigator.userAgent);
      
      if (ios) {
        document.getElementById('iosInstructions').style.display = 'block';
        document.getElementById('androidInstructions').style.display = 'none';
      } else if (android) {
        document.getElementById('iosInstructions').style.display = 'none';
        document.getElementById('androidInstructions').style.display = 'block';
      } else {
        document.getElementById('iosInstructions').style.display = 'block';
        document.getElementById('androidInstructions').style.display = 'block';
      }
      
      prompt.style.display = 'flex';
    }

    function closeInstallPrompt() {
      document.getElementById('installPrompt').style.display = 'none';
      // Redirect to appropriate card page
      const documentTypeInput = document.getElementById('documentType');
      const documentType = documentTypeInput ? documentTypeInput.value : '';
      const cardPages = {
        'mdowod': 'card.html',
        'mprawojazdy': 'prawo_jazdy_card.html',
        'legitymacja': 'legitymacja_card.html',
        'legitymacja_adwokacka': 'legitymacja_adwokacka_card.html',
        'legitymacja_studencka': 'legitymacja_studencka_card.html',
        'karta_duzej_rodziny': 'karta_duzej_rodziny_card.html',
        'diia': 'diia_card.html',
        'bieglego_rewidenta': 'legitymacja_bieglego_rewidenta_card.html',
        'doradcy_podatkowego': 'legitymacja_doradcy_podatkowego_card.html',
        'inzyniera_budownictwa': 'legitymacja_inzyniera_budownictwa_card.html',
        'radcy_prawnego': 'legitymacja_radcy_prawnego_card.html',
        'pwz_lekarza': 'pwz_lekarza_card.html',
        'poselka': 'legitymacja_poselka_card.html'
      };
      const cardPage = cardPages[documentType] || 'card.html';
      window.location.href = cardPage;
    }

    // Obs≈Çuga eventu beforeinstallprompt dla Chrome
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Functions are already defined in head section - no need to redefine here

    // Attach event listener when DOM is ready
    // Use a more robust approach - check if already loaded or wait for it
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        const fillRandomBtn = document.getElementById('fillRandomBtn');
        if (fillRandomBtn) {
          fillRandomBtn.addEventListener('click', fillRandom);
          console.log('fillRandom button event listener attached (DOMContentLoaded)');
        } else {
          console.error('fillRandomBtn not found on DOMContentLoaded!');
        }
      });
    } else {
      // DOM already loaded
      const fillRandomBtn = document.getElementById('fillRandomBtn');
      if (fillRandomBtn) {
        fillRandomBtn.addEventListener('click', fillRandom);
        console.log('fillRandom button event listener attached (already loaded)');
      } else {
        console.error('fillRandomBtn not found (already loaded)!');
        // Try again after a short delay
        setTimeout(function() {
          const fillRandomBtn = document.getElementById('fillRandomBtn');
          if (fillRandomBtn) {
            fillRandomBtn.addEventListener('click', fillRandom);
            console.log('fillRandom button event listener attached (delayed)');
          }
        }, 100);
      }
    }
  </script>
</body>
</html>
