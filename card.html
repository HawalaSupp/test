<html lang="pl">
<head>
  <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiIiwic2hvcnRfbmFtZSI6IiIsInRoZW1lX2NvbG9yIjoiIzEwMTMxNyIsImJhY2tncm91bmRfY29sb3IiOiIjMTAxMzE3IiwiZGlzcGxheSI6InN0YW5kYWxvbmUifQ==">
  <title>mObywatel</title>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="assets/app/main.css">
  <link rel="stylesheet" href="assets/app/card.css">
  <style>
    /* Hide content initially to prevent flicker */
    .id_data_grid,
    .confirm_info,
    .id_bottom {
      opacity: 0;
      transition: opacity 0.3s ease-in;
    }
    .content-loaded .id_data_grid,
    .content-loaded .confirm_info,
    .content-loaded .id_bottom {
      opacity: 1;
    }
  </style>
  <link rel="icon" type="image/x-icon" href="assets/app/images/AppIcon~phone~1792@2x~180x180.png">
  <link rel="apple-touch-icon" href="assets/app/images/AppIcon~phone~1792@2x~180x180.png">
  <link rel="shortcut icon" href="assets/app/images/AppIcon~phone~1792@2x~180x180.png">
</head>
<body>
  <button class="refresh_button" onclick="window.location.href = window.location.href.split("?")[0] + "?t=" + Date.now()" title="Force Refresh">↻</button>

  <div class="top_grid_fixed">
    <div class="action_grid_fixed">
      <img src="assets/app/images/back_blue.png" class="back_img_fixed" alt="">
      <p onclick="sendTo('documents.html')" class="back_text_fixed">Dokumenty</p>
    </div>
    <p class="title_text_fixed" style="white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">mDowód</p>
    <img src="assets/app/images/help.png" class="help_img_fixed" id="helpIconBtn" alt="" style="cursor: pointer; pointer-events: auto !important; z-index: 1000; position: relative;" onclick="if(window.toggleEagleDrag){window.toggleEagleDrag();}else{console.log('Function not ready');}">
  </div>

  <div class="bottom_bar">
    <div class="bottom_bar_grid">
      <div class="bottom_element_grid" send="documents.html">
        <div class="bottom_element_image documents_open"></div>
        <p class="bottom_element_text open">Dokumenty</p>
      </div>
      <div class="bottom_element_grid" send="services.html">
        <div class="bottom_element_image services"></div>
        <p class="bottom_element_text">Usługi</p>
      </div>
      <div class="bottom_element_grid" send="qr.html">
        <div class="bottom_element_image qr"></div>
        <p class="bottom_element_text">Kod QR</p>
      </div>
      <div class="bottom_element_grid" send="more.html">
        <div class="bottom_element_image more"></div>
        <p class="bottom_element_text">Więcej</p>
      </div>
    </div>
  </div>

  <div class="container">
    <p class="time_text" id="time">Czas: 01:28:22 27.10.2025</p>

    <div class="id_wrapper">
      <div class="id_image_data">
        <div id="bg_image_controls" style="display: none; position: fixed; top: 100px; right: 20px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; z-index: 1000;">
          <label style="color: white; display: block; margin-bottom: 10px;">Width: <span id="widthValue">100</span>%</label>
          <input type="range" id="widthSlider" min="50" max="150" value="100" style="width: 200px; margin-bottom: 15px;">
          <label style="color: white; display: block; margin-bottom: 10px;">Height: <span id="heightValue">100</span>%</label>
          <input type="range" id="heightSlider" min="50" max="150" value="100" style="width: 200px;">
        </div>
        <div id="eagle_arrow_controls" style="display: none; position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; z-index: 1000;">
          <div style="display: grid; grid-template-columns: repeat(3, 40px); grid-template-rows: repeat(3, 40px); gap: 5px; justify-items: center; align-items: center;">
            <div></div>
            <button id="arrowUp" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 5px; color: white; font-size: 20px; cursor: pointer;">↑</button>
            <div></div>
            <button id="arrowLeft" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 5px; color: white; font-size: 20px; cursor: pointer;">←</button>
            <div></div>
            <button id="arrowRight" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 5px; color: white; font-size: 20px; cursor: pointer;">→</button>
            <div></div>
            <button id="arrowDown" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 5px; color: white; font-size: 20px; cursor: pointer;">↓</button>
            <div></div>
          </div>
        </div>
        <img draggable="false" class="id_image" id="bgImage" src="assets/app/images/idCardBackground.png" alt="">
        <img draggable="false" class="id_image_effect" src="assets/app/images/idCardEffect.png" alt="">
        <div class="inset"></div>

        <div class="id_own_image" id="userPhoto" style="background-image:url('assets/app/images/blank.png');"></div>

        <img draggable="false" src="assets/app/images/flaga koks.webp" class="flag_video" alt="">
        <img draggable="false" src="assets/app/images/flaga koks.webp" class="flag_video flag_video_overlay" alt="">
        <div class="eagle_wrapper">
          <img draggable="false" src="assets/app/images/newandreworked.png" class="eagle_video" alt="">
          <div class="hologram_shine"></div>
        </div>
        <p class="eagle_text">Rzeczpospolita<br>Polska</p>

        <div class="id_data_grid">
          <div class="data_holder">
            <p class="data_title firstname" id="name"></p>
            <p class="data_value">Imię (imiona)</p>
          </div>
          <div class="data_holder">
            <p class="data_title surname" id="surname"></p>
            <p class="data_value">Nazwisko</p>
          </div>
          <div class="data_holder">
            <p class="data_title" id="nationality"></p>
            <p class="data_value">Obywatelstwo</p>
          </div>
          <div class="data_holder">
            <p class="data_title" id="birthday"></p>
            <p class="data_value">Data urodzenia</p>
          </div>
          <div class="data_holder">
            <p class="data_title" id="pesel_value"></p>
            <p class="data_value">Numer PESEL</p>
          </div>
        </div>
      </div>

      <div class="id_bottom">
        <div class="bottom_grid" style="position:relative;top:4px;">
          <img class="bottom_image" src="./assets/app/images/kutasnowy123.png" alt="checkmark">
          <p class="bottom_text" style="color:#5ae675;font-weight:450;font-size:13px;margin-left:5px;position:relative;top:-1.5px;">Dokument ważny</p>
        </div>
      </div>
    </div>

    <div class="under_container">
      <div class="under_grid">
        <div class="under_icon" onclick="sendTo('scan.html', 'card.html')">
          <div class="under_image_circle">
            <img class="under_image under_image_bright" src="assets/app/images/confirm.png" alt="">
          </div>
          <p class="under_text">Potwierdź swoje dane</p>
        </div>
        <div class="under_icon" onclick="sendTo('document.html')">
          <div class="under_image_circle">
            <img class="under_image" src="assets/app/images/IB025_Dane_dowoduosobistego_card_mini@3x.png" alt="">
          </div>
          <p class="under_text">Dane dowodu osobistego</p>
        </div>
        <div class="under_icon" onclick="sendTo('pesel.html')">
          <div class="under_image_circle">
            <img class="under_image under_image_blue under_image_larger" src="assets/app/images/AC004_Lock_pesel@3x.png" alt="">
          </div>
          <p class="under_text">Zastrzeż<br>PESEL</p>
        </div>
        <div class="under_icon" onclick="sendTo('shortcuts.html')">
          <div class="under_image_circle">
            <img class="under_image under_image_small under_image_blue" src="assets/app/images/more.png" alt="">
          </div>
          <p class="under_text">Pozostałe skróty</p>
        </div>
      </div>
    </div>

    <div class="confirm_info">
      <div class="confirm_box">
        <p class="box_top">Seria i numer mDowodu</p>
        <p class="box_value box_highlight" id="seriesAndNumber"></p>
        <button class="main_button_filled" onclick="navigator.clipboard.writeText(document.getElementById('seriesAndNumber').textContent)">Kopiuj</button>
        <p class="box_description">Dane mDowodu i dowodu osobistego są inne - to dwa różne dokumenty.</p>
      </div>
      <div class="confirm_box">
        <p class="box_top">Termin ważności mDowodu</p>
        <p class="box_value" id="expiryDate"></p>
      </div>
      <div class="confirm_box">
        <p class="box_top">Data wydania mDowodu</p>
        <p class="box_value" id="givenDate"></p>
      </div>
      <div class="confirm_box">
        <p class="box_top">Imię ojca</p>
        <p class="box_value" id="fathersName"></p>
      </div>
      <div class="confirm_box" style="border:none;">
        <p class="box_top">Imię matki</p>
        <p class="box_value" id="mothersName"></p>
      </div>
    </div>

    <div class="other_grid">
      <div class="bottom_holder info_holder">
        <div class="bottom_grid">
          <p class="bottom_text" style="margin-left:0px;">Twoje dodatkowe dane</p>
        </div>
  <img class="action_arrow" src="assets/app/images/right_arrow_sharp.png" alt="">
        <div class="additional_holder">
          <div class="additional_grid">
            <p class="additional_title">Nazwisko rodowe</p>
            <p class="additional_subtitle" id="familyName"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Płeć</p>
            <p class="additional_subtitle" id="sex"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Nazwisko rodowe ojca</p>
            <p class="additional_subtitle" id="fathersFamilyName"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Nazwisko rodowe matki</p>
            <p class="additional_subtitle" id="mothersFamilyName"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Miejsce urodzenia</p>
            <p class="additional_subtitle" id="birthPlace"></p>
          </div>
        </div>
      </div>

      <div class="bottom_holder" style="height:95px;margin-bottom:130px;">
        <div class="bottom_update">
          <div class="bottom_update_grid">
            <p class="bottom_update_text" style="margin-left:0px;">Ostatnia aktualizacja</p>
            <p class="bottom_update_value" id="updateDate" style="margin-left:0px;"></p>
          </div>
          <button class="main_button_filled update" style="right:20px;" onclick="location.reload()">Aktualizuj</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/app/bar.js"></script>
  <script src="assets/app/card.js"></script>
  <script src="assets/app/manifest.js"></script>
  <script src="assets/app/cache.js"></script>

  <script>
    // ============================================================
    // SIMPLE AND DIRECT DATA LOADING FOR mDowód
    // ============================================================
    
    // Helper function to set text content of an element by ID
    function setField(id, value) {
      const el = document.getElementById(id);
      if (el && value) {
        el.textContent = value;
        console.log('✓ Set', id, 'to:', value);
      }
    }
    
    // Load all data directly from localStorage - SIMPLE APPROACH
    function loadAllData() {
      console.log('=== LOADING ALL DATA FROM LOCALSTORAGE ===');
      
      // Try to get JSON data first (with mdowod_ prefix)
      let data = {};
      const jsonData = localStorage.getItem('mdowod_userData');
      if (jsonData) {
        try {
          data = JSON.parse(jsonData);
          console.log('Loaded mdowod_userData JSON:', data);
        } catch (e) {
          console.error('Error parsing mdowod_userData JSON:', e);
        }
      }
      
      // Get individual fields from localStorage with mdowod_ prefix (these override JSON if present)
      const name = localStorage.getItem('mdowod_name') || data.name || '';
      const surname = localStorage.getItem('mdowod_surname') || data.surname || '';
      const nationality = localStorage.getItem('mdowod_nationality') || data.nationality || '';
      const pesel = localStorage.getItem('mdowod_pesel') || data.pesel || '';
      const seriesAndNumber = localStorage.getItem('mdowod_seriesAndNumber') || data.seriesAndNumber || '';
      const givenDate = localStorage.getItem('mdowod_givenDate') || data.givenDate || '';
      const expiryDate = localStorage.getItem('mdowod_expiryDate') || data.expiryDate || '';
      const fathersName = localStorage.getItem('mdowod_fathersName') || data.fathersName || '';
      const mothersName = localStorage.getItem('mdowod_mothersName') || data.mothersName || '';
      const familyName = localStorage.getItem('mdowod_familyName') || data.familyName || '';
      const fathersFamilyName = localStorage.getItem('mdowod_fathersFamilyName') || data.fathersFamilyName || '';
      const mothersFamilyName = localStorage.getItem('mdowod_mothersFamilyName') || data.mothersFamilyName || '';
      const birthPlace = localStorage.getItem('mdowod_birthPlace') || data.birthPlace || '';
      const sex = localStorage.getItem('mdowod_sex') || data.sex || '';
      const birthDay = localStorage.getItem('mdowod_birthDay') || '';
      const updateDate = localStorage.getItem('mdowod_update') || localStorage.getItem('mdowod_updateDate') || '';
      
      // Format birthday from day/month/year if birthDay is not available
      let birthday = birthDay;
      if (!birthday && (data.day || data.month || data.year)) {
        const day = String(data.day || 1).padStart(2, '0');
        const month = String(data.month || 1).padStart(2, '0');
        const year = data.year || 2000;
        birthday = `${day}.${month}.${year}`;
      }
      
      // Format sex
      let sexText = '';
      if (sex === 'm') sexText = 'MĘŻCZYZNA';
      else if (sex === 'k') sexText = 'KOBIETA';
      
      console.log('Data to display:');
      console.log('  name:', name);
      console.log('  surname:', surname);
      console.log('  nationality:', nationality);
      console.log('  pesel:', pesel);
      console.log('  seriesAndNumber:', seriesAndNumber);
      console.log('  givenDate:', givenDate);
      console.log('  expiryDate:', expiryDate);
      console.log('  fathersName:', fathersName);
      console.log('  mothersName:', mothersName);
      console.log('  familyName:', familyName);
      console.log('  birthday:', birthday);
      console.log('  sex:', sexText);
      
      // Set all fields - DIRECTLY, no complex logic
      setField('name', name.toUpperCase());
      setField('surname', surname.toUpperCase());
      setField('nationality', nationality.toUpperCase());
      setField('pesel_value', pesel);
      setField('seriesAndNumber', seriesAndNumber);
      setField('givenDate', givenDate);
      setField('expiryDate', expiryDate);
      setField('fathersName', fathersName.toUpperCase());
      setField('mothersName', mothersName.toUpperCase());
      setField('familyName', familyName.toUpperCase());
      setField('fathersFamilyName', fathersFamilyName.toUpperCase());
      setField('mothersFamilyName', mothersFamilyName.toUpperCase());
      setField('birthPlace', birthPlace.toUpperCase());
      setField('birthday', birthday);
      setField('sex', sexText);
      setField('updateDate', updateDate);
      
      // Load user photo (mdowod_ prefix or generic fallback)
      const userPhoto = localStorage.getItem('mdowod_userPhoto') || localStorage.getItem('userPhoto');
      if (userPhoto) {
        const photoEl = document.getElementById('userPhoto');
        if (photoEl) {
          photoEl.style.backgroundImage = `url(${userPhoto})`;
          console.log('✓ Loaded user photo');
        }
      }
      
      console.log('=== DATA LOADING COMPLETE ===');
    }
    
    // Setup dropdown toggle for "Twoje dodatkowe dane"
    function setupDropdown() {
      const infoHolders = document.querySelectorAll('.info_holder');
      infoHolders.forEach(holder => {
        holder.addEventListener('click', function(e) {
          // Don't toggle if clicking on a link or button inside
          if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
          
          const additionalHolder = this.querySelector('.additional_holder');
          const arrow = this.querySelector('.action_arrow');
          
          if (additionalHolder) {
            const isOpen = additionalHolder.style.display === 'block';
            additionalHolder.style.display = isOpen ? 'none' : 'block';
            if (arrow) {
              arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
            }
            console.log('Toggled dropdown:', isOpen ? 'closed' : 'open');
          }
        });
        holder.style.cursor = 'pointer';
      });
    }
    
    // Run on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      loadAllData();
      setupDropdown();
    });

    // === Load data and image from IndexedDB ===
    async function loadUserData() {
      try {
        const db = await getDb();
        
        // NEW APPROACH: Load from localStorage first (more reliable)
        console.log('=== Loading data from localStorage ===');
        let userData = null;
        let dataSource = 'none';
        
        // Try to load from localStorage JSON first (MOST RECENT) - with mdowod_ prefix
        const jsonData = localStorage.getItem('mdowod_userData');
        const jsonTimestamp = localStorage.getItem('mdowod_userData_timestamp');
        if (jsonData) {
          try {
            userData = JSON.parse(jsonData);
            dataSource = 'localStorage JSON';
            console.log('✓ Loaded data from mdowod_userData JSON');
            console.log('  Timestamp:', jsonTimestamp ? new Date(parseInt(jsonTimestamp)).toISOString() : 'unknown');
            console.log('  Data:', userData);
            console.log('  Name:', userData.name, 'Surname:', userData.surname);
          } catch (e) {
            console.error('Error parsing mdowod_userData JSON:', e);
          }
        }
        
        // If not in localStorage JSON, try IndexedDB
        if (!userData) {
          console.log('Not in localStorage JSON, trying IndexedDB...');
          const indexedData = await getData(db, 'data');
          if (indexedData) {
            userData = { ...indexedData };
            delete userData.data;
            dataSource = 'IndexedDB';
            console.log('✓ Loaded data from IndexedDB:', userData);
            console.log('  Name:', userData.name, 'Surname:', userData.surname);
          }
        }
        
        // If still no data, try loading individual fields from localStorage with mdowod_ prefix
        if (!userData) {
          console.log('Not in IndexedDB, trying individual localStorage fields with mdowod_ prefix...');
          const name = localStorage.getItem('mdowod_name');
          const surname = localStorage.getItem('mdowod_surname');
          if (name || surname) {
            userData = {
              name: name,
              surname: surname,
              nationality: localStorage.getItem('mdowod_nationality'),
              familyName: localStorage.getItem('mdowod_familyName'),
              fathersName: localStorage.getItem('mdowod_fathersName'),
              mothersName: localStorage.getItem('mdowod_mothersName'),
              fathersFamilyName: localStorage.getItem('mdowod_fathersFamilyName'),
              mothersFamilyName: localStorage.getItem('mdowod_mothersFamilyName'),
              birthPlace: localStorage.getItem('mdowod_birthPlace'),
              sex: localStorage.getItem('mdowod_sex'),
              day: parseInt(localStorage.getItem('mdowod_day')) || 1,
              month: parseInt(localStorage.getItem('mdowod_month')) || 1,
              year: parseInt(localStorage.getItem('mdowod_year')) || 2000,
              pesel: localStorage.getItem('mdowod_pesel'),
              seriesAndNumber: localStorage.getItem('mdowod_seriesAndNumber'),
              givenDate: localStorage.getItem('mdowod_givenDate'),
              expiryDate: localStorage.getItem('mdowod_expiryDate')
            };
            dataSource = 'individual localStorage fields';
            console.log('✓ Loaded data from individual localStorage fields:', userData);
            console.log('  Name:', userData.name, 'Surname:', userData.surname);
            console.log('  PESEL:', userData.pesel, 'SeriesAndNumber:', userData.seriesAndNumber);
            console.log('  GivenDate:', userData.givenDate, 'ExpiryDate:', userData.expiryDate);
          }
        }
        
        // IMPORTANT: Even if userData exists, make sure these fields are included from localStorage with mdowod_ prefix
        // This ensures they're always available even if they weren't in the JSON/IndexedDB
        if (userData) {
          if (!userData.pesel) userData.pesel = localStorage.getItem('mdowod_pesel');
          if (!userData.seriesAndNumber) userData.seriesAndNumber = localStorage.getItem('mdowod_seriesAndNumber');
          if (!userData.givenDate) userData.givenDate = localStorage.getItem('mdowod_givenDate');
          if (!userData.expiryDate) userData.expiryDate = localStorage.getItem('mdowod_expiryDate');
          console.log('✓ Ensured mDowód fields are in userData:');
          console.log('  PESEL:', userData.pesel, 'SeriesAndNumber:', userData.seriesAndNumber);
          console.log('  GivenDate:', userData.givenDate, 'ExpiryDate:', userData.expiryDate);
        }
        
        console.log('=== Data source:', dataSource, '===');
        
        if (userData && Object.keys(userData).length > 0) {
          console.log('Final userData to display:', userData);
          
          // Use loadReadyData from card.js if available (it handles all the formatting)
          if (typeof loadReadyData === 'function') {
            console.log('Calling loadReadyData from card.js with:', userData);
            loadReadyData(userData);
            
            // CRITICAL: After loadReadyData, directly set mDowód fields from localStorage as fallback
            // This ensures they're always displayed even if loadReadyData didn't set them
            setTimeout(() => {
              console.log('=== Setting mDowód fields directly from localStorage (fallback) ===');
              
              // Check ALL possible localStorage keys for these fields with mdowod_ prefix
              const pesel = localStorage.getItem('mdowod_pesel') || userData?.pesel;
              const seriesAndNumber = localStorage.getItem('mdowod_seriesAndNumber') || userData?.seriesAndNumber;
              const givenDate = localStorage.getItem('mdowod_givenDate') || userData?.givenDate;
              const expiryDate = localStorage.getItem('mdowod_expiryDate') || userData?.expiryDate;
              
              console.log('  Direct localStorage values:');
              console.log('    pesel:', pesel, '(from localStorage:', localStorage.getItem('mdowod_pesel'), ', from userData:', userData?.pesel, ')');
              console.log('    seriesAndNumber:', seriesAndNumber, '(from localStorage:', localStorage.getItem('mdowod_seriesAndNumber'), ', from userData:', userData?.seriesAndNumber, ')');
              console.log('    givenDate:', givenDate, '(from localStorage:', localStorage.getItem('mdowod_givenDate'), ', from userData:', userData?.givenDate, ')');
              console.log('    expiryDate:', expiryDate, '(from localStorage:', localStorage.getItem('mdowod_expiryDate'), ', from userData:', userData?.expiryDate, ')');
              
              // Also check what's actually in localStorage
              console.log('  All localStorage keys:', Object.keys(localStorage).filter(k => k.includes('mdowod_')));
              
              if (pesel) {
                const peselEl = document.getElementById('pesel_value');
                if (peselEl) {
                  peselEl.textContent = pesel;
                  console.log('  ✓ Set pesel_value directly to:', pesel);
                  // Verify it stuck
                  setTimeout(() => {
                    if (peselEl.textContent !== pesel) {
                      console.error('  ✗✗✗ pesel_value was overwritten! Re-setting...');
                      peselEl.textContent = pesel;
                    }
                  }, 100);
                } else {
                  console.error('  ✗ pesel_value element not found!');
                }
              } else {
                console.warn('  ⚠ pesel is empty - checking localStorage keys:', Object.keys(localStorage).filter(k => k.toLowerCase().includes('pesel')));
              }
              
              if (seriesAndNumber) {
                const seriesEl = document.getElementById('seriesAndNumber');
                if (seriesEl) {
                  seriesEl.textContent = seriesAndNumber;
                  console.log('  ✓ Set seriesAndNumber directly to:', seriesAndNumber);
                  // Verify it stuck
                  setTimeout(() => {
                    if (seriesEl.textContent !== seriesAndNumber) {
                      console.error('  ✗✗✗ seriesAndNumber was overwritten! Re-setting...');
                      seriesEl.textContent = seriesAndNumber;
                    }
                  }, 100);
                } else {
                  console.error('  ✗ seriesAndNumber element not found!');
                }
              } else {
                console.warn('  ⚠ seriesAndNumber is empty - checking localStorage keys:', Object.keys(localStorage).filter(k => k.toLowerCase().includes('series')));
              }
              
              if (givenDate) {
                const givenEl = document.getElementById('givenDate');
                if (givenEl) {
                  givenEl.textContent = givenDate;
                  console.log('  ✓ Set givenDate directly to:', givenDate);
                  // Verify it stuck
                  setTimeout(() => {
                    if (givenEl.textContent !== givenDate) {
                      console.error('  ✗✗✗ givenDate was overwritten! Re-setting...');
                      givenEl.textContent = givenDate;
                    }
                  }, 100);
                } else {
                  console.error('  ✗ givenDate element not found!');
                }
              } else {
                console.warn('  ⚠ givenDate is empty - checking localStorage keys:', Object.keys(localStorage).filter(k => k.toLowerCase().includes('given')));
              }
              
              if (expiryDate) {
                const expiryEl = document.getElementById('expiryDate');
                if (expiryEl) {
                  expiryEl.textContent = expiryDate;
                  console.log('  ✓ Set expiryDate directly to:', expiryDate);
                  // Verify it stuck
                  setTimeout(() => {
                    if (expiryEl.textContent !== expiryDate) {
                      console.error('  ✗✗✗ expiryDate was overwritten! Re-setting...');
                      expiryEl.textContent = expiryDate;
                    }
                  }, 100);
                } else {
                  console.error('  ✗ expiryDate element not found!');
                }
              } else {
                console.warn('  ⚠ expiryDate is empty - checking localStorage keys:', Object.keys(localStorage).filter(k => k.toLowerCase().includes('expiry')));
              }
            }, 200);
          } else {
            // Fallback: Set form fields from IndexedDB data directly
            console.log('loadReadyData not available, setting data directly');
            if (userData.name) setData('name', userData.name.toUpperCase());
            if (userData.surname) setData('surname', userData.surname.toUpperCase());
            if (userData.nationality) setData('nationality', userData.nationality.toUpperCase());
            if (userData.familyName) setData('familyName', userData.familyName.toUpperCase());
            if (userData.fathersName) setData('fathersName', userData.fathersName.toUpperCase());
            if (userData.fathersFamilyName) setData('fathersFamilyName', userData.fathersFamilyName.toUpperCase());
            if (userData.mothersName) setData('mothersName', userData.mothersName.toUpperCase());
            if (userData.mothersFamilyName) setData('mothersFamilyName', userData.mothersFamilyName.toUpperCase());
            if (userData.birthPlace) setData('birthPlace', userData.birthPlace.toUpperCase());
            
            if (userData.sex === 'm') setData('sex', 'MĘŻCZYZNA');
            else if (userData.sex === 'k') setData('sex', 'KOBIETA');
            
            // Format birthday
            if (userData.day && userData.month && userData.year) {
              const day = String(userData.day).padStart(2, '0');
              const month = String(userData.month).padStart(2, '0');
              setData('birthday', `${day}.${month}.${userData.year}`);
            }
          }
        } else {
          console.log('No userData found');
        }
        
        // Show content once data is loaded (or even if no data)
        document.body.classList.add('content-loaded');

        // Load image from IndexedDB
        const urlParams = new URLSearchParams(window.location.search);
        const photoUrl = urlParams.get('image');
        if (photoUrl) {
          // Use setImage function from card.js if available, otherwise set directly
          if (typeof setImage === 'function') {
            setImage(photoUrl);
          } else {
            const photoEl = document.getElementById('userPhoto') || document.querySelector('.id_own_image');
            if (photoEl) {
              photoEl.style.backgroundImage = `url(${photoUrl})`;
            }
          }
          console.log('Image loaded from URL:', photoUrl);
          return;
        }

        // Try localStorage first with mdowod_ prefix
        const photoFromLocalStorage = localStorage.getItem('mdowod_userPhoto');
        if (photoFromLocalStorage) {
          if (typeof setImage === 'function') {
            setImage(photoFromLocalStorage);
          } else {
            const photoEl = document.getElementById('userPhoto') || document.querySelector('.id_own_image');
            if (photoEl) {
              photoEl.style.backgroundImage = `url(${photoFromLocalStorage})`;
            }
          }
          console.log('Image loaded from localStorage');
          return;
        }

        // Load from IndexedDB
        const imageData = await getData(db, 'image');
        console.log('Image data from IndexedDB:', imageData);
        if (imageData && imageData.image) {
          if (typeof setImage === 'function') {
            setImage(imageData.image);
          } else {
            const photoEl = document.getElementById('userPhoto') || document.querySelector('.id_own_image');
            if (photoEl) {
              photoEl.style.backgroundImage = `url(${imageData.image})`;
              console.log('Image loaded from IndexedDB');
            } else {
              console.error('Photo element not found');
            }
          }
        } else {
          console.log('No image data found in IndexedDB');
        }
      } catch (error) {
        console.error('Error loading data from IndexedDB:', error);
      }
    }

    // Don't define setData here - use the one from card.js
    // If card.js setData doesn't exist, we'll use a fallback
    if (typeof window.setData !== 'function' && typeof setData !== 'function') {
      window.setData = function(id, value) {
        const el = document.getElementById(id);
        if (el && value) {
          el.textContent = value;
        }
      };
      console.log('Created fallback setData function');
    } else {
      console.log('Using setData from card.js');
    }

    // Load data and image when DOM is ready and after card.js loads
    let dataLoaded = false; // Prevent duplicate loads
    
    // Try to load data synchronously from localStorage first (instant, no flicker)
    (function loadDataSync() {
      try {
        const jsonData = localStorage.getItem('userData');
        if (jsonData) {
          const userData = JSON.parse(jsonData);
          if (typeof loadReadyData === 'function' && userData && Object.keys(userData).length > 0) {
            // Load data immediately
            loadReadyData(userData);
            // Show content
            if (document.body) {
              document.body.classList.add('content-loaded');
            } else {
              document.addEventListener('DOMContentLoaded', () => {
                document.body.classList.add('content-loaded');
              });
            }
            dataLoaded = true;
            console.log('Data loaded synchronously from localStorage');
            return true;
          }
        }
      } catch (e) {
        console.log('Could not load data synchronously:', e);
      }
      return false;
    })();
    
    function initUserData() {
      if (dataLoaded) {
        console.log('initUserData: Data already loaded, skipping');
        return;
      }
      // Load data immediately - no delay to prevent flicker
      console.log('initUserData: Checking if loadReadyData is available:', typeof loadReadyData);
      if (!dataLoaded) {
        dataLoaded = true;
        loadUserData();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initUserData);
    } else {
      initUserData();
    }

    // === Simple Background Draggable Functionality ===
    (function() {
      let isDraggable = false;
      let isDragging = false;
      let xOffset = 0;
      let yOffset = 0;
      let currentWidth = 100;
      let currentHeight = 100;
      let initialX = 0;
      let initialY = 0;
      let bgImage = null;
      let controlsDiv = null;
      let widthSlider = null;
      let heightSlider = null;
      let widthValue = null;
      let heightValue = null;

      // Eagle draggable state
      let eagleDraggable = false;
      let eagleDragging = false;
      let eagleXOffset = 0;
      let eagleYOffset = 0;
      let eagleInitialX = 0;
      let eagleInitialY = 0;
      let eagleWrapper = null;

      function updateTransform() {
        if (bgImage) {
          bgImage.style.transform = `translate(${xOffset}px, ${yOffset}px) scaleX(${currentWidth / 100}) scaleY(${currentHeight / 100})`;
        }
      }

      function updateEagleTransform() {
        if (eagleWrapper) {
          eagleWrapper.style.transform = `translate(${eagleXOffset}px, ${eagleYOffset}px)`;
        }
      }

      function setupDraggable() {
        bgImage = document.getElementById('bgImage');
        const helpIcon = document.getElementById('helpIconBtn') || document.querySelector('.help_img_fixed');
        controlsDiv = document.getElementById('bg_image_controls');
        widthSlider = document.getElementById('widthSlider');
        heightSlider = document.getElementById('heightSlider');
        widthValue = document.getElementById('widthValue');
        heightValue = document.getElementById('heightValue');
        eagleWrapper = document.querySelector('.eagle_wrapper');

        if (!bgImage || !helpIcon || !controlsDiv || !eagleWrapper) {
          console.log('Waiting for elements...');
          setTimeout(setupDraggable, 200);
          return;
        }

        console.log('Setting up draggable functionality');

        // Load saved values for background
        const savedX = localStorage.getItem('bgImageX');
        const savedY = localStorage.getItem('bgImageY');
        const savedWidth = localStorage.getItem('bgImageWidth');
        const savedHeight = localStorage.getItem('bgImageHeight');
        
        if (savedX !== null) xOffset = parseFloat(savedX);
        if (savedY !== null) yOffset = parseFloat(savedY);
        if (savedWidth !== null) {
          currentWidth = parseFloat(savedWidth);
          if (widthSlider) widthSlider.value = currentWidth;
          if (widthValue) widthValue.textContent = Math.round(currentWidth);
        }
        if (savedHeight !== null) {
          currentHeight = parseFloat(savedHeight);
          if (heightSlider) heightSlider.value = currentHeight;
          if (heightValue) heightValue.textContent = Math.round(currentHeight);
        }

        // Load saved values for eagle
        const savedEagleX = localStorage.getItem('eagleX');
        const savedEagleY = localStorage.getItem('eagleY');
        if (savedEagleX !== null) eagleXOffset = parseFloat(savedEagleX);
        if (savedEagleY !== null) eagleYOffset = parseFloat(savedEagleY);

        // Apply saved transforms
        updateTransform();
        updateEagleTransform();

        // Toggle function - make it globally accessible
        window.toggleEagleDrag = function() {
          if (!bgImage || !controlsDiv || !eagleWrapper) {
            console.log('Elements not ready, calling setup...');
            setupDraggable();
            setTimeout(() => window.toggleEagleDrag(), 100);
            return;
          }
          
          isDraggable = !isDraggable;
          eagleDraggable = !eagleDraggable;
          console.log('Toggle controls:', isDraggable);
          
          const arrowControls = document.getElementById('eagle_arrow_controls');
          
          if (isDraggable) {
            bgImage.style.pointerEvents = 'auto';
            bgImage.style.cursor = 'move';
            controlsDiv.style.display = 'block';
            if (arrowControls) arrowControls.style.display = 'block';
            updateTransform();
            updateEagleTransform();
          } else {
            bgImage.style.pointerEvents = 'none';
            bgImage.style.cursor = 'default';
            controlsDiv.style.display = 'none';
            if (arrowControls) arrowControls.style.display = 'none';
            isDragging = false;
            localStorage.setItem('bgImageX', xOffset);
            localStorage.setItem('bgImageY', yOffset);
            localStorage.setItem('bgImageWidth', currentWidth);
            localStorage.setItem('bgImageHeight', currentHeight);
            localStorage.setItem('eagleX', eagleXOffset);
            localStorage.setItem('eagleY', eagleYOffset);
          }
        };

        // Attach click handler multiple ways
        helpIcon.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          window.toggleEagleDrag();
        };
        helpIcon.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          window.toggleEagleDrag();
        }, true);
        helpIcon.style.cursor = 'pointer';
        helpIcon.style.pointerEvents = 'auto';
        helpIcon.style.zIndex = '10000';

        // Arrow button handlers
        const arrowUp = document.getElementById('arrowUp');
        const arrowDown = document.getElementById('arrowDown');
        const arrowLeft = document.getElementById('arrowLeft');
        const arrowRight = document.getElementById('arrowRight');

        const moveStep = 1; // pixels to move per click

        if (arrowUp) {
          arrowUp.addEventListener('click', function() {
            eagleYOffset -= moveStep;
            updateEagleTransform();
            localStorage.setItem('eagleY', eagleYOffset);
          });
        }

        if (arrowDown) {
          arrowDown.addEventListener('click', function() {
            eagleYOffset += moveStep;
            updateEagleTransform();
            localStorage.setItem('eagleY', eagleYOffset);
          });
        }

        if (arrowLeft) {
          arrowLeft.addEventListener('click', function() {
            eagleXOffset -= moveStep;
            updateEagleTransform();
            localStorage.setItem('eagleX', eagleXOffset);
          });
        }

        if (arrowRight) {
          arrowRight.addEventListener('click', function() {
            eagleXOffset += moveStep;
            updateEagleTransform();
            localStorage.setItem('eagleX', eagleXOffset);
          });
        }

        // Background drag handlers
        bgImage.addEventListener('mousedown', function(e) {
          if (!isDraggable) return;
          e.preventDefault();
          initialX = e.clientX - xOffset;
          initialY = e.clientY - yOffset;
          isDragging = true;
        });

        document.addEventListener('mousemove', function(e) {
          if (isDragging && isDraggable) {
            e.preventDefault();
            xOffset = e.clientX - initialX;
            yOffset = e.clientY - initialY;
            updateTransform();
          }
        });

        document.addEventListener('mouseup', function() {
          isDragging = false;
        });

        // Background touch handlers
        bgImage.addEventListener('touchstart', function(e) {
          if (!isDraggable) return;
          e.preventDefault();
          const touch = e.touches[0];
          initialX = touch.clientX - xOffset;
          initialY = touch.clientY - yOffset;
          isDragging = true;
        });

        document.addEventListener('touchmove', function(e) {
          if (isDragging && isDraggable) {
            e.preventDefault();
            const touch = e.touches[0];
            xOffset = touch.clientX - initialX;
            yOffset = touch.clientY - initialY;
            updateTransform();
          }
        });

        document.addEventListener('touchend', function() {
          isDragging = false;
        });

        // Slider handlers
        if (widthSlider) {
          widthSlider.addEventListener('input', function(e) {
            currentWidth = parseFloat(e.target.value);
            if (widthValue) widthValue.textContent = Math.round(currentWidth);
            updateTransform();
          });
        }

        if (heightSlider) {
          heightSlider.addEventListener('input', function(e) {
            currentHeight = parseFloat(e.target.value);
            if (heightValue) heightValue.textContent = Math.round(currentHeight);
            updateTransform();
          });
        }
      }

      // Start setup
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupDraggable);
      } else {
        setupDraggable();
      }
      setTimeout(setupDraggable, 500);
      setTimeout(setupDraggable, 1000);
    })();
  </script>

</body>
</html>
